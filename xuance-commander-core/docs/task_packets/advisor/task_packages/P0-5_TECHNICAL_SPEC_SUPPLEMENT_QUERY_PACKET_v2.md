# P0-5 技術規格文件補充任務 追問包 v2（URGENT）

**狀態**：`URGENT` · `ACTIVE`  
**建立日期**：2026-01-10  
**版本**：v2.0  
**適用範圍**：P0-5 技術規格設計階段（補充任務 - 追問 v2）

---

## ⚠️ 重要聲明：實際產出缺失

**問題**：用戶聲稱「已完整產出 7 份 SPEC 文件」，但經實際驗證，**僅有 2 份文件（SPEC-1、SPEC-2）已完整寫入，其餘 5 份文件（SPEC-3 ～ SPEC-7）尚未寫入**。

**原因**：用戶提供的內容為**摘要版本**，並非可直接寫入的完整文件。

**要求**：請**實際產出**剩餘 5 份 SPEC 文件的完整內容，並達到「工程可直接實作（Cursor-Executable）」水準。

---

## 一、問題說明（Problem Statement）

### 1.1 當前狀態

**已完整寫入的文件**：
- ✅ `P0-5/P0-5_TECHNICAL_ARCHITECTURE.md`（SPEC-1，462 行）
- ✅ `P0-5/P0-5_DATA_STRUCTURE_SPEC.md`（SPEC-2，790 行）

**缺失的文件**（需要**實際產出**）：
- ❌ `P0-5/P0-5_IMPLEMENTATION_GUIDE.md`（SPEC-3）
- ❌ `P0-5/P0-5_COMPONENT_SPEC_COMPASS.md`（SPEC-4）
- ❌ `P0-5/P0-5_LOGIC_SPEC_RISK_RESULT.md`（SPEC-5）⭐ **重點**
- ❌ `P0-5/P0-5_TECHNICAL_RISKS.md`（SPEC-6）
- ❌ `P0-5/P0-5_TESTING_STRATEGY.md`（SPEC-7）

### 1.2 問題根源

用戶提供的摘要版本內容**不足**，無法達到「工程可直接實作（Cursor-Executable）」水準。需要：

1. **完整的文件結構**：每個 SPEC 文件必須包含完整的章節、子章節、詳細說明
2. **可實作的偽代碼**：所有關鍵算法必須提供可直接實作的偽代碼或實作思路
3. **完整的資料結構定義**：所有資料結構必須提供完整的 TypeScript 類型定義或 JSON Schema
4. **詳細的驗收標準**：所有驗收點必須提供可重跑的驗收步驟

---

## 二、必須產出的文件清單（Required Deliverables）

### 2.1 SPEC-3：實作指南

**文件位置**：`P0-5/P0-5_IMPLEMENTATION_GUIDE.md`

**必須包含**（基於追問包 v1 的要求）：

1. **目錄結構設計**（D2）
   - `ui/` 目錄的**完整結構設計**（包含所有子目錄與文件的完整路徑）
   - 每個目錄的**職責說明**（至少 3-5 句話）
   - 與 `prototype/` 的**關係說明**（參考 vs 遷移，至少 2-3 段）

2. **i18n 實作指南**（D4）
   - 即時切換方案（**完整的實作步驟**，包含狀態管理、組件更新機制、動態文本更新邏輯）
   - 原生語感保證機制（**完整的組織方式**，包含 Key-Value 結構設計、內容產出流程）
   - **實作步驟與程式碼結構建議**（至少 5-10 個步驟）
   - **關鍵演算法的偽代碼或實作思路**（完整的偽代碼，可直接轉換為 TypeScript）

3. **Theme Engine 實作指南**（D5）
   - `theme_config` 讀取與解析邏輯（**完整的實作步驟**，包含錯誤處理）
   - 容錯與降級機制（**完整的 Fail-soft 實現**，包含所有降級場景）
   - Neutral Ritual Skin 的應用方式（**完整的應用流程**）
   - **實作步驟與程式碼結構建議**（至少 5-10 個步驟）
   - **關鍵演算法的偽代碼或實作思路**（完整的偽代碼，可直接轉換為 TypeScript）

4. **Adapter → Interceptor → Store 接線**（關鍵流程）
   - **完整的接線流程圖**（從 Raw JSON 到 UI 渲染的完整流程）
   - **每個接線點的詳細說明**（至少 3-5 句話）
   - **錯誤處理流程**（完整的錯誤處理鏈）

5. **專案初始化步驟**
   - React + Vite 專案建立步驟（**完整的命令序列**，可直接執行）
   - 依賴安裝清單（**完整的 package.json 依賴列表**，包含版本號）
   - 目錄結構建立步驟（**完整的 mkdir 命令序列**）
   - 基本配置檔案（**完整的 Vite config、TypeScript config 內容**，可直接使用）

**參考資料**：
- 技術規格結案包：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` 第 3 章「D2, D4, D5」
- 工程執行報告：`P0-5/P0-5_IMPLEMENTATION_EXECUTION_REPORT.md` 第 4 章「核心交付物」
- 現有原型代碼：`prototype/app.js`（可作為參考，需重構）

---

### 2.2 SPEC-4：Stage 2 羅盤組件規格

**文件位置**：`P0-5/P0-5_COMPONENT_SPEC_COMPASS.md`

**必須包含**（基於追問包 v1 的要求）：

1. **SVG 結構設計**（D3）
   - 放射狀/同心圓布局算法（**完整的算法公式**，包含所有參數定義）
   - 符碼分布算法（**完整的分布邏輯**，包含 20-30 個符碼如何分布在 3-5 層同心圓軌道上）
   - 符碼位置計算公式（**完整的極坐標轉換公式**，包含所有變數定義）
   - 符碼間距與密度控制（**完整的間距控制邏輯**）
   - SVG 元素結構（**完整的 SVG 結構定義**，包含所有必需的 SVG 元素與屬性）
   - 符碼資料結構（**完整的 TypeScript 類型定義**）
   - 符碼視覺樣式配置（**完整的樣式配置結構**）

2. **互動邏輯設計**
   - 點擊邏輯（**完整的點擊檢測算法**，包含 hit area 計算）
   - 選取邏輯（**完整的選取狀態管理邏輯**，包含已選符碼的標記方式）
   - 吸附邏輯（**完整的飛入/吸附動畫算法**，包含路徑計算與時間函數）
   - 確認邏輯（**完整的完成判斷邏輯**，包含選取數量驗證）

3. **RWD 適配方案**
   - **桌面端**：完整羅盤顯示（**完整的 SVG 尺寸計算**、視窗適應邏輯）
   - **手機端**：旋盤/撥動模式（**完整的觸控事件處理邏輯**，包含 touchstart/touchmove/touchend 處理）
   - **平板端**：中間尺寸適配（**完整的響應式斷點定義**）
   - 響應式斷點定義（**完整的斷點列表**，包含所有裝置尺寸）
   - 觸控事件處理（**完整的手勢識別邏輯**，包含旋盤角度的計算）

4. **動畫策略**
   - 符碼點亮動畫（**完整的動畫參數**，包含 opacity、scale、duration）
   - 符碼飛入動畫（**完整的動畫路徑**，包含 translate、scale、easing）
   - 符碼吸附動畫（**完整的吸附效果**，包含最後 150ms 的 easing）
   - 轉場動畫（**完整的轉場效果**，包含進入 Stage 3 的動畫）

5. **絕對紅線檢查**
   - **完整的紅線檢查清單**（至少 5-10 項禁止事項）
   - **完整的驗收標準**（如何確保「無任何問卷化控件」）
   - **完整的檢查方法**（如何驗證「儀式感互動」）

**參考資料**：
- 技術規格結案包：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` 第 3 章「D3: Stage 2 萬象羅盤」
- UMIP 結案報告：`P0-5/P0-5_UMIP_CLOSURE_REPORT.md` 第 4 章「Stage 2：萬象定物象」

---

### 2.3 SPEC-5：Risk 邏輯與結果呈現規格 ⭐ **重點**

**文件位置**：`P0-5/P0-5_LOGIC_SPEC_RISK_RESULT.md`

**必須包含**（基於追問包 v1 的要求）：

1. **RiskOverride Middleware/Interceptor 邏輯設計**（D6）
   - 攔截邏輯詳細設計（**完整的攔截點定義**，包含 Adapter Output → Risk Interceptor → Store.setState() → View Render 的完整流程）
   - `risk_level` 檢測邏輯（**完整的檢測算法**，包含所有判斷條件）
   - 攔截點位置（**完整的接線說明**，包含在 Adapter 之後、Store 更新之前的確切位置）
   - 覆蓋行為詳細設計（**完整的覆蓋邏輯**，包含如何強制丟棄原 L4 建議、如何寫入靜態安全模板）
   - Template A/B 的管理與選擇邏輯（**完整的管理邏輯**，包含如何選擇使用哪個模板）
   - 防止閃爍機制（FOUC 避免）（**完整的防護機制**，包含如何確保動態 L4 內容在 HIGH 狀態下從未進入 UI State）
   - **實作步驟與程式碼結構建議**（至少 5-10 個步驟）
   - **關鍵演算法的偽代碼或實作思路**（完整的偽代碼，可直接轉換為 TypeScript）

2. **L1-L4 結果分層揭示邏輯**（D7）
   - 揭示順序鎖定邏輯（**完整的順序控制邏輯**，包含如何確保揭示順序不可變更）
   - 每個層級的揭示條件（**完整的條件定義**，包含 L1、L2、L3、L4 的揭示條件）
   - L3 主動揭示機制（**完整的互動方式設計**，包含點擊/長按/展開的詳細邏輯）
   - 「撥霧」隱喻的視覺表現（**完整的視覺設計**，包含動畫效果）
   - 隱藏與顯示的狀態管理（**完整的狀態機定義**，包含所有狀態轉換）
   - 高風險鎖定機制（**完整的鎖定邏輯**，包含當 `risk_level = HIGH` 時 L4 如何強制顯示安全模板）
   - 動態 L4 的完全忽略邏輯（**完整的忽略邏輯**，包含如何確保動態 L4 內容從未進入 Store）
   - 動畫策略（**完整的動畫設計**，包含 L1-L4 的所有動畫效果）

3. **Stage 3 投射定歸因詳細技術規格** ⭐ **重點補充項**
   - **投射卡片元件設計**：
     - 卡片結構（**完整的卡片結構定義**，包含標題區域、選項區域、確認按鈕區域的完整佈局）
     - 題目資料結構（**完整的 TypeScript 類型定義**，包含如何從 `compiled_facet.json` 讀取題目）
     - 題目的 i18n 處理（**完整的 i18n 處理流程**，包含 CN/EN 切換的詳細邏輯）
     - 選項呈現方式（**完整的呈現方式定義**，包含圖像、文字、狀態描述的呈現邏輯）
     - 選項的資料結構（**完整的 TypeScript 類型定義**，包含 `id`, `label`, `visual_id`, `description` 等欄位）
     - 選項的視覺樣式（**完整的樣式定義**，包含如何符合「象/狀態」要求的詳細說明）
   - **互動邏輯設計**：
     - 單選 vs 多選判斷（**完整的判斷邏輯**，包含根據題目的 `type` 欄位的詳細處理）
     - 選項點擊/選擇邏輯（**完整的點擊處理邏輯**，包含如何標記已選選項、如何處理取消選擇）
     - 答案收集與暫存（**完整的暫存邏輯**，包含答案的資料結構、如何暫存答案）
     - 轉場動畫（**完整的動畫設計**，包含題目切換動畫、選項確認動畫的詳細參數）
   - **流程控制設計**：
     - 題目順序（**完整的順序控制邏輯**，包含是否允許跳題、如何控制順序）
     - 完成判斷（**完整的完成判斷邏輯**，包含何時進入 Stage 4、完成條件的詳細定義）
     - 答案提交時機（**完整的提交邏輯**，包含完成所有題目後提交，或逐題提交的詳細流程）
     - 答案資料結構（**完整的 TypeScript 類型定義**，包含如何組織答案、如何傳遞給評分引擎）
   - **RWD 適配**：
     - 桌面端卡片呈現（**完整的桌面端設計**，包含卡片尺寸、位置、布局的詳細定義）
     - 手機端卡片呈現（**完整的手機端設計**，包含是否需要全屏、觸控優化的詳細說明）
     - 平板端適配（**完整的平板端設計**，包含中間尺寸、觸控與滑鼠雙支援的詳細邏輯）
   - **絕對紅線檢查**：
     - **完整的紅線檢查清單**（至少 5-10 項禁止事項）
     - **完整的驗收標準**（如何確保「無數值評分」「無問卷化控件」「儀式感互動」）

**參考資料**：
- 技術規格結案包：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` 第 3 章「D6, D7」、第 6 章「Stage 3 投射定歸因規格補充」
- UMIP 結案報告：`P0-5/P0-5_UMIP_CLOSURE_REPORT.md` 第 4 章「Stage 3：投射定歸因」、第 5 章「結果頁面呈現規格」
- 高風險模板：`P0-3/R2_METAPHOR_BOUNDARY_BANLIST_HIGHRISK_TEMPLATES.md` 第 4 章「R4 高風險觸發：L4 固定模板」

---

### 2.4 SPEC-6：技術風險評估

**文件位置**：`P0-5/P0-5_TECHNICAL_RISKS.md`

**必須包含**（基於追問包 v1 的要求）：

1. **技術風險清單**
   - **性能風險**：
     - Stage 2 羅盤 SVG 渲染性能（**詳細的性能分析**，包含 20-30 個符碼的渲染開銷計算）
     - 手機端性能（**詳細的性能分析**，包含觸控事件處理、動畫流暢度的性能瓶頸）
     - i18n 即時切換性能（**詳細的性能分析**，包含大量文字更新的性能影響）
   - **相容性風險**：
     - 瀏覽器相容性（**詳細的相容性分析**，包含 SVG、Touch Events、CSS 特性的相容性問題）
     - 裝置相容性（**詳細的相容性分析**，包含桌面、平板、手機的觸控/滑鼠支援問題）
   - **可維護性風險**：
     - Adapter Pattern 的複雜度（**詳細的複雜度分析**，包含資料轉換邏輯的維護成本）
     - 主題切換機制的複雜度（**詳細的複雜度分析**，包含 `theme_config` 的擴展性問題）
   - **可擴展性風險**：
     - 新增 Facet 的擴展成本（**詳細的成本分析**，包含更換 JSON 的影響範圍）
     - 新增 Stage 的擴展成本（**詳細的成本分析**，包含新增 Stage 的影響範圍）
   - **實作風險**：
     - 羅盤退化成問卷 UI（**詳細的風險分析**，包含如何避免問卷化退化的策略）
     - 英文敘事失真（**詳細的風險分析**，包含如何確保英文原生語感的策略）
     - 高風險漏蓋（**詳細的風險分析**，包含如何確保 L4 不被洩漏的策略）

2. **對 MVP Gate 的影響**
   - **各風險對 6 項 Gate 的影響**（每個風險至少說明 2-3 個 Gate 的影響）
   - **風險優先級評估**（至少列出前 5 個最高優先級的風險）

3. **緩解對策（Mitigation）**
   - **每個風險的詳細緩解對策**（至少 2-3 項對策）
   - **對策的實施步驟**（至少 3-5 個步驟）
   - **對策的有效性驗證**（如何驗證對策的有效性）

**參考資料**：
- 技術規格結案包：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` 第 4 章「技術風險與對策」
- 工程執行報告：`P0-5/P0-5_IMPLEMENTATION_EXECUTION_REPORT.md` 第 5 章「執行路線圖與風險緩解」

---

### 2.5 SPEC-7：測試策略

**文件位置**：`P0-5/P0-5_TESTING_STRATEGY.md`

**必須包含**（基於追問包 v1 的要求）：

1. **6 項 MVP Gate（可重跑驗收）**
   - **Gate #1：資料串接 & 遮罩（Raw Data Masking）**
     - Action（**完整的操作步驟**，至少 5-10 個步驟）
     - Check（**完整的檢查清單**，至少 5-10 項檢查點）
     - Fail-soft（**完整的降級測試**，包含所有降級場景）
   - **Gate #2：CN/EN 即時切換（No-Reload）**
     - Action（**完整的操作步驟**，至少 5-10 個步驟）
     - Check（**完整的檢查清單**，至少 5-10 項檢查點）
     - 驗收證據（**完整的證據要求**，包含截圖、錄影、日誌等）
   - **Gate #3：Stage 2 羅盤（桌面/手機）**
     - Action（**完整的操作步驟**，至少 5-10 個步驟）
     - Check（**完整的檢查清單**，至少 5-10 項檢查點）
     - 桌面端測試（**完整的桌面端測試場景**）
     - 手機端測試（**完整的手機端測試場景**，包含旋盤模式）
   - **Gate #4：L1-L4 分層揭示**
     - Action（**完整的操作步驟**，至少 5-10 個步驟）
     - Check（**完整的檢查清單**，至少 5-10 項檢查點）
     - 揭示順序驗證（**完整的順序驗證邏輯**）
   - **Gate #5：高風險覆蓋（Interceptor）**
     - Action（**完整的操作步驟**，至少 5-10 個步驟）
     - Check（**完整的檢查清單**，至少 5-10 項檢查點）
     - DOM 檢查（**完整的 DOM 檢查方法**，包含如何檢查動態 L4 內容不存在）
     - Store 檢查（**完整的 Store 檢查方法**，包含如何檢查 `dynamic_body_key` 不存在）
   - **Gate #6：視覺解耦（Theme Engine）**
     - Action（**完整的操作步驟**，至少 5-10 個步驟）
     - Check（**完整的檢查清單**，至少 5-10 項檢查點）
     - 主題切換測試（**完整的主題切換測試場景**）
     - 降級測試（**完整的降級測試場景**）

2. **測試工具建議**
   - Unit 測試（**完整的測試框架建議**，包含 Vitest 的配置、測試用例範例）
   - E2E 測試（**完整的測試框架建議**，包含 Playwright 的配置、測試腳本範例）

3. **自動化檢查建議（紅線掃描）**
   - **完整的自動化檢查腳本**（可直接執行的腳本）
   - **完整的檢查規則**（至少 10-20 項檢查規則）
   - **完整的檢查結果報告格式**（包含如何解讀檢查結果）

**參考資料**：
- 技術規格結案包：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` 第 5 章「6 MVP Gates」
- 工程執行報告：`P0-5/P0-5_IMPLEMENTATION_EXECUTION_REPORT.md` 第 6 章「6 MVP Gate 檢查清單」

---

## 三、產出要求（Output Requirements）

### 3.1 完整性要求

每個 SPEC 文件必須：
- **包含完整的章節結構**（至少 5-10 個主要章節）
- **包含詳細的子章節說明**（每個章節至少 3-5 個子章節）
- **包含可實作的偽代碼或實作思路**（所有關鍵算法必須提供完整的偽代碼）
- **包含完整的資料結構定義**（所有資料結構必須提供完整的 TypeScript 類型定義）
- **包含詳細的驗收標準**（所有驗收點必須提供可重跑的驗收步驟）

### 3.2 可實作性要求

每個 SPEC 文件必須達到「工程可直接實作（Cursor-Executable）」水準：
- **Cursor 可以直接讀取並理解**：文件結構清晰，說明完整
- **Cursor 可以直接實作**：提供完整的偽代碼、資料結構定義、驗收標準
- **Cursor 可以直接驗證**：提供完整的驗收步驟，可重跑驗收

### 3.3 驗證要求

補充的文件必須通過以下驗證：

1. **文件存在性驗證**：所有 5 份文件必須存在於指定路徑
2. **內容完整性驗證**：所有文件必須包含任務包要求的所有內容
3. **可實作性驗證**：所有文件必須達到「工程可直接實作（Cursor-Executable）」水準

---

## 四、驗證指令（Verification Command）

補充完成後，執行以下指令驗證所有文件是否存在且完整：

```bash
cd xuance-commander-core/P0-5

# 驗證文件存在性
for f in \
  P0-5_IMPLEMENTATION_GUIDE.md \
  P0-5_COMPONENT_SPEC_COMPASS.md \
  P0-5_LOGIC_SPEC_RISK_RESULT.md \
  P0-5_TECHNICAL_RISKS.md \
  P0-5_TESTING_STRATEGY.md
do
  if [ -f "$f" ]; then
    lines=$(wc -l < "$f" | xargs)
    echo "✅ $f ($lines 行)"
    if [ "$lines" -lt 200 ]; then
      echo "   ⚠️  警告：文件行數過少，可能內容不完整"
    fi
  else
    echo "❌ $f 不存在"
  fi
done
```

**預期結果**：
- 所有 5 份文件均顯示 ✅
- 每份文件至少 200 行（確保內容完整）

---

## 五、時限要求（Deadline）

**URGENT**：請盡快補充剩餘 5 份 SPEC 文件的完整內容。

**建議時限**：24 小時內完成。

---

## 六、參考文件（Reference Documents）

1. **已完整寫入的文件**（可作為參考範本）：
   - `P0-5/P0-5_TECHNICAL_ARCHITECTURE.md`（SPEC-1，462 行）
   - `P0-5/P0-5_DATA_STRUCTURE_SPEC.md`（SPEC-2，790 行）

2. **任務包要求**：
   - `docs/task_packets/advisor/task_packages/P0-5_TECHNICAL_SPEC_SUPPLEMENT_TASK_PACKET.md`（追問包 v1）

3. **審核報告**：
   - `P0-5/P0-5_SPEC_FILES_AUDIT_REPORT.md`（詳細的審核結果與缺失內容清單）

---

**End of Query Packet v2**

