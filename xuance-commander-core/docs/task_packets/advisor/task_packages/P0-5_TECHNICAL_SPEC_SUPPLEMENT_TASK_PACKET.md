# P0-5 技術規格文件補充任務包（Technical Specification Supplement Task Packet）

**狀態**：ACTIVE | EDITABLE | REFERENCE（非硬性、可隨時修正）  
**建立日期**：2026-01-10  
**版本**：v1.0  
**任務類型**：技術規格文件補充（Technical Specification Supplement）  
**目標受眾**：GPT（技術理解與升華）、Gemini（技術方案發散與細節補齊）

---

## ⚠️ 重要聲明：所有內容保留修改空間

**本任務包中的所有設計、規格、決策均為暫時性版本，不得凍結。**

- 所有技術決策均可在後續討論中調整
- 所有架構設計、組件規格、實現方式均可修改
- 所有「最終版本」「確定方案」的說法均指「當前可執行的方案」，非永久凍結

**目標**：完成技術規格設計結案包中標註為「待產出」的 7 份規格文件，以及補充 Stage 3 規格細節和 Stage 1 接口預留機制。

---

**文件放置規範**：請參考 `docs/governance/CURSOR_FILE_PLACEMENT_RULE.md`

---

## 一、專案／任務背景摘要

### 1.1 這是什麼專案

**P0-5 技術規格文件補充任務**是 P0-5 技術規格設計階段的補充任務，旨在完成技術規格設計結案包中標註為「待產出」的規格文件。

**核心價值**：
- **完整性**：確保技術規格文件完整，作為工程實作的詳細技術指南
- **可實作性**：確保規格文件足夠詳細，供 Cursor 直接依此實作（無需額外猜測）
- **可驗證性**：確保規格文件包含明確的驗收標準與測試策略

**與主任務的關係**：
- **主任務**：P0-5 技術規格設計（已完成，有條件通過）
- **補充任務**：完成主任務中標註為「待產出」的部分
- **成果**：補充任務完成後，技術規格設計階段才真正完整

### 1.2 為什麼現在要做這件事

**當前狀態**：
- ✅ **技術規格設計結案包已通過審核**：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` v1.0 已定案
- ✅ **核心技術決策已明確**：React + Vite, Zustand, Adapter Pattern 等決策已確立
- ✅ **絕對紅線與驗收標準已定義**：6 項 MVP Gate 驗收標準已明確
- ⏳ **7 份規格文件待產出**：SPEC-1 至 SPEC-7 目前均為「待產出」狀態
- ⏳ **Stage 3 規格細節待補充**：需要在 SPEC-5 或單獨文件中詳細說明
- ⏳ **Stage 1 接口預留機制待明確**：需要在 SPEC-1 的「架構擴展性」章節中說明

**為什麼需要補充任務**：
- 技術規格結案包雖然通過了審核，但 7 份詳細規格文件尚未產出
- 這些規格文件是工程實作的詳細技術指南，缺少它們會影響實作效率
- Stage 3 和 Stage 1 的規格細節需要在實作前補充，確保實作時有明確指引

### 1.3 這次任務在整體中扮演什麼位置

**專案階段定位**：
```
P0-5 技術規格設計階段（已完成，有條件通過）
    ↓
P0-5 技術規格文件補充任務（當前階段）← 你現在在這裡
    ↓
P0-5 工程實作階段（待開始）
    ↓
P0-5 驗收與結案階段（待完成）
    ↓
P1-1 使用者驗證階段（未來）
```

**本次任務的產出將直接成為工程實作的詳細技術指南**。

---

## 二、與本次任務相關的「過往任務回顧」

### 2.1 之前做過哪些相關嘗試

#### ✅ 已完成階段

**P0-5 技術規格設計階段（主任務）**
- **技術規格結案包已建立**：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` v1.0
  - 8 個核心交付物的驗收標準（D1-D8）
  - 核心技術決策（React + Vite, Zustand, Adapter Pattern）
  - 絕對紅線與工程約束
  - 6 項 MVP Gate 驗收標準（含可重跑證據要求）
  - 工程執行順序建議
- **審核狀態**：✅ 已通過總工程師審核（有條件通過）
- **審核意見**：技術規格設計整體品質優秀，特別是 RiskOverride 的 Interceptor 模式修正和絕對紅線的詳細程度。需在實際工程中補充 Stage 3 規格細節和 Stage 1 接口預留機制說明，不影響結案。

**P0-5 設計階段（已完成）**
- **UMIP v1.0 結案報告**：`P0-5/P0-5_UMIP_CLOSURE_REPORT.md` v1.0
  - 絕對紅線、UI 架構、4-Stage 實作規格、結果呈現規格、6 項 MVP Gate
- **UI 架構設計**：`P0-5/P0-5_UI_ARCHITECTURE.md`
- **UI 串接規格**：`P0-5/P0-5_UI_INTEGRATION_SPEC.md`
- **工程執行報告**：`P0-5/P0-5_IMPLEMENTATION_EXECUTION_REPORT.md` v3.0

#### ⚠️ 已標註但尚未完成的部分

**7 份規格文件（SPEC-1 至 SPEC-7）**
- **狀態**：目前均為「待產出」狀態
- **說明**：技術規格結案包第 2 章「必須產出的 7 份規格文件（SPEC）」中列出了這 7 份文件，但尚未產出
- **需求**：需要在本補充任務中完成

**Stage 3 投射定歸因規格細節**
- **狀態**：基本規格已有（來自 UMIP 結案報告），但詳細技術規格待補充
- **基本規格**：
  - UI：投射卡片，一題一頁
  - 互動：直覺選擇（象/狀態），不得出現數值評分
- **待補充**：投射卡片元件設計、互動邏輯、流程控制、RWD 適配、絕對紅線檢查
- **位置**：建議在 SPEC-5 (`P0-5_LOGIC_SPEC_RISK_RESULT.md`) 或單獨的 `P0-5_COMPONENT_SPEC_STAGE3.md` 中說明

**Stage 1 接口預留機制**
- **狀態**：基本策略已有（允許延後），但接口設計待明確
- **基本策略**：
  - P0-5 策略：若資源允許則實作；否則可由 Stage 2 直接啟動（仍需預留接口）
  - UI：八卦轉輪或星圖（占位即可）
- **待補充**：路由接口、資料接口、組件接口設計
- **位置**：建議在 SPEC-1 (`P0-5_TECHNICAL_ARCHITECTURE.md`) 的「架構擴展性」章節中說明

### 2.2 哪些已完成、哪些待補充

**已完成**：
- ✅ 技術規格結案包（核心決策、驗收標準、絕對紅線）
- ✅ UMIP v1.0 結案報告（Stage 1-4 基本規格、L1-L4 結果呈現規格）
- ✅ 工程執行報告（8 個交付物、執行順序、風險控管）

**待補充**：
- ⏳ 7 份規格文件（SPEC-1 至 SPEC-7）
- ⏳ Stage 3 投射定歸因詳細技術規格
- ⏳ Stage 1 接口預留機制設計

### 2.3 哪些方向已被否定或暫停

**無需關注的方向**（已在主任務中明確排除）：
- ❌ 新增功能：不新增 UMIP 以外的流程、題型或互動
- ❌ 定稿視覺：不定稿最終視覺風格，僅需產出機制
- ❌ 極致優化：排除非關鍵動畫的效能或視覺極致優化

**本補充任務的重點**：
- ✅ 產出詳細的技術規格文件，而非創新的設計
- ✅ 補充主任務中標註為「待完善」的部分，而非擴展範圍

---

## 三、目前已完成的結果或階段性結論

### 3.1 已經有哪些初步成果

#### ✅ 技術規格結案包（完整且可參考）

**文件位置**：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` v1.0

**內容包括**：
- 8 個核心交付物的驗收標準（D1-D8）
- 7 份規格文件的產出要求清單（SPEC-1 至 SPEC-7）
- 核心技術決策（React + Vite, Zustand, Adapter Pattern）
- 絕對紅線與工程約束（互動、數據遮罩、安全）
- 6 項 MVP Gate 驗收標準（含可重跑證據要求）
- 工程執行順序建議

**關鍵技術亮點**：
- ✅ RiskOverride 的 Interceptor 模式修正（避免 FOUC）
- ✅ 數據遮罩紅線的詳細程度（涵蓋 Console Log、Network Payload 等）
- ✅ 絕對紅線的明確性（互動、數據遮罩、安全三條紅線）

#### ✅ UMIP 結案報告（基本規格已明確）

**文件位置**：`P0-5/P0-5_UMIP_CLOSURE_REPORT.md` v1.0

**內容包括**：
- Stage 1-4 的基本 UI 規格
- L1-L4 結果呈現規格
- 絕對紅線與硬規則
- 6 項 MVP Gate 驗收標準

**Stage 3 基本規格**（來自 UMIP 結案報告）：
- UI：投射卡片，一題一頁
- 互動：直覺選擇（象/狀態），不得出現數值評分
- 對應：任務包「Stage 3：萬象定歸因（具體題目回答）」

**Stage 1 基本策略**（來自 UMIP 結案報告）：
- P0-5 策略：若資源允許則實作；否則可由 Stage 2 直接啟動（仍需預留接口）
- UI：八卦轉輪或星圖（占位即可）
- 彈性空間：若時間不足，可簡化為「直接進入 Stage 2」的入口

#### ✅ 工程執行報告（交付物與執行順序已明確）

**文件位置**：`P0-5/P0-5_IMPLEMENTATION_EXECUTION_REPORT.md` v3.0

**內容包括**：
- 8 個核心交付物清單（D1-D8）
- 技術決策狀態說明（已鎖定 vs 可替換）
- 執行順序與風險控管策略
- 6 項 MVP Gate 的工程化檢核定義

### 3.2 哪些東西「暫時可用」

#### ✅ 可直接參考的文件

- **技術規格結案包**：可作為規格文件產出的絕對權威依據
- **UMIP 結案報告**：可作為 Stage 1-4 基本規格的參考
- **工程執行報告**：可作為交付物與執行順序的參考

#### ⚠️ 需要擴展為詳細規格的內容

- **Stage 3 投射定歸因**：基本規格已有，但詳細技術規格（元件設計、互動邏輯、流程控制、RWD 適配）待補充
- **Stage 1 接口預留機制**：基本策略已有，但接口設計（路由接口、資料接口、組件接口）待明確

### 3.3 哪些仍不確定

#### ❓ 需要在本補充任務中解決的問題

1. **SPEC-1: 技術架構設計文件**
   - **問題**：整體架構圖、Adapter 詳解、資料流、Stage 1 接口預留機制如何設計？
   - **約束**：必須符合 Adapter Pattern、Pure Renderer 原則、隱喻解耦原則
   - **需求**：需要提供詳細的架構設計、組件架構、資料流設計、Stage 1 接口預留機制說明

2. **SPEC-2: 資料結構規格**
   - **問題**：UMIP Schema v1 完整定義、i18n 資料結構、`theme_config` 結構的詳細定義為何？
   - **約束**：必須符合 UMIP 規格、必須支援 fail-soft、必須支援擴展
   - **需求**：需要提供完整的 JSON Schema 定義、資料結構設計、範例 JSON

3. **SPEC-3: 實作指南**
   - **問題**：目錄結構、i18n 實作指南、Theme Engine 實作指南的詳細內容為何？
   - **約束**：必須符合技術規格結案包中的決策（React + Vite, Zustand, Adapter Pattern）
   - **需求**：需要提供詳細的實作步驟、程式碼結構建議、關鍵演算法偽代碼

4. **SPEC-4: Stage 2 羅盤組件規格**
   - **問題**：Stage 2 羅盤 SVG 互動規格、RWD 適配方案、動畫策略的詳細內容為何？
   - **約束**：必須符合「放射狀/同心圓結構」，必須支援 20-30 個符碼，必須支援手機端旋盤模式
   - **需求**：需要提供詳細的 SVG 結構設計、互動邏輯設計、RWD 適配方案、動畫策略

5. **SPEC-5: Risk 邏輯與結果呈現規格**
   - **問題**：RiskOverride 邏輯、L1-L4 揭示順序、**Stage 3 投射定歸因規格**的詳細內容為何？
   - **約束**：必須符合 Interceptor 模式（避免 FOUC）、必須遵循 L1→L2→L3→L4 順序、必須符合絕對紅線
   - **需求**：需要提供詳細的 RiskOverride 邏輯設計、L1-L4 揭示邏輯、**Stage 3 投射定歸因詳細技術規格**

6. **SPEC-6: 技術風險評估**
   - **問題**：技術風險與對策、風險對 MVP Gate 驗收的影響為何？
   - **約束**：必須識別所有潛在技術風險、必須提供對策與緩解方案
   - **需求**：需要提供詳細的技術風險清單、對策與緩解方案、對 MVP Gate 驗收的影響評估

7. **SPEC-7: 測試策略**
   - **問題**：測試策略與 Gate 驗收案例、單元測試、整合測試、E2E 測試的詳細內容為何？
   - **約束**：必須驗證 6 項 MVP Gate、必須驗證絕對紅線、必須可重複執行
   - **需求**：需要提供詳細的測試策略、測試用例設計、Gate 驗收案例

8. **Stage 1 接口預留機制**
   - **問題**：路由接口、資料接口、組件接口的詳細設計為何？
   - **約束**：必須確保未來可擴展、必須不影響 Stage 2 的正常運行
   - **需求**：需要提供詳細的接口設計、擴展點說明、未來實作時的整合方式

---

## 四、本次希望推進的下一個目標

### 4.1 核心目標（一句話）

**產出完整的 7 份技術規格文件（SPEC-1 至 SPEC-7），以及補充 Stage 3 投射定歸因詳細技術規格和 Stage 1 接口預留機制設計，供 Cursor 作為工程實作的詳細技術指南。**

### 4.2 想補強哪一段

#### 🎯 優先補強（必須完整）

1. **SPEC-1: 技術架構設計文件**
   - 整體架構圖（組件層級、資料流、狀態管理）
   - Adapter Pattern 詳解（資料轉換邏輯、ViewModel 結構）
   - 資料流設計（Compiled Facet JSON → Adapter → ViewModel → Components）
   - **Stage 1 接口預留機制**（路由接口、資料接口、組件接口）

2. **SPEC-2: 資料結構規格**
   - UMIP Schema v1 完整 JSON Schema 定義（含所有必需欄位）
   - i18n 資料結構設計（CN/EN 雙語組織方式、動態文本處理）
   - `theme_config` 結構設計（隱喻 ID、視覺資產、字體配色、容錯機制）
   - 至少 2 組完整的範例 JSON（Normal / High Risk）

3. **SPEC-5: Risk 邏輯與結果呈現規格**
   - RiskOverride Middleware/Interceptor 邏輯設計（避免 FOUC）
   - L1-L4 分層揭示邏輯（揭示順序、互動方式、動畫策略）
   - **Stage 3 投射定歸因詳細技術規格**（投射卡片元件設計、互動邏輯、流程控制、RWD 適配、絕對紅線檢查）

4. **SPEC-4: Stage 2 羅盤組件規格**
   - SVG 結構設計（放射狀/同心圓布局算法、符碼分布）
   - 互動邏輯設計（點擊、選取、吸附、確認）
   - RWD 適配方案（桌面端 vs 手機端旋盤模式）
   - 動畫策略（符碼點亮、飛入、吸附等）

#### 🎯 次要補強（可簡化但需明確）

5. **SPEC-3: 實作指南**
   - 目錄結構設計（`ui/` 目錄組織方式）
   - i18n 實作指南（即時切換方案、原生語感保證機制）
   - Theme Engine 實作指南（`theme_config` 讀取、容錯、降級機制）

6. **SPEC-6: 技術風險評估**
   - 技術風險清單（性能、相容性、可維護性、可擴展性）
   - 對策與緩解方案
   - 對 MVP Gate 驗收的影響評估

7. **SPEC-7: 測試策略**
   - 6 項 MVP Gate 的測試用例設計
   - 絕對紅線的測試驗證方法
   - 單元測試、整合測試、E2E 測試策略

### 4.3 想擴展還是收斂

**本次任務的定位是「收斂」**：

- **不擴展**：不新增功能需求，不修改 UMIP 規格，不改變技術決策
- **只收斂**：將現有的基本規格「收斂」為詳細、可執行的技術規格文件

**收斂的目標**：
- 將「基本規格描述」轉化為「詳細技術規格」
- 將「抽象的設計要求」轉化為「具體的實作指南」
- 將「模糊的實作要求」轉化為「可驗證的技術標準」

### 4.4 想驗證某個假設，還是單純找靈感

**本次任務的定位是「技術規格文件產出」，而非「靈感探索」**：

- **目標**：產出明確、詳細的技術規格文件，而非創新的設計方案
- **方法**：基於現有技術規格結案包、UMIP 結案報告、工程執行報告，進行細節補齊與規格深化
- **驗證**：技術規格的合理性與可實作性（需考慮 Cursor 的實作能力與專案約束）

**但允許以下「技術方案比較」**：
- 不同實作方案的優劣比較（需提供決策依據）
- 不同技術選型的適用性分析（需說明選擇理由）

---

## 五、思考與產出期待（取代角色設定）

### 5.1 技術理解與升華（GPT 的主要責任）

**請以「技術架構師」的視角**，理解技術規格結案包與相關文件，並進行技術規格深化：

1. **架構設計深化**
   - 理解 Adapter Pattern 在專案中的具體應用
   - 設計符合「Pure Renderer」定位的完整架構
   - 設計 Stage 1 接口預留機制，確保未來可擴展

2. **資料結構設計**
   - 設計完整的 UMIP Schema v1（所有必需欄位、約束、fallback）
   - 設計 i18n 資料結構（CN/EN 雙語組織、動態文本處理）
   - 設計 `theme_config` 結構（隱喻解耦、容錯機制）

3. **組件規格設計**
   - 設計 Stage 2 羅盤組件的完整技術規格（SVG 結構、互動邏輯、RWD 適配）
   - 設計 Stage 3 投射定歸因組件的完整技術規格（卡片設計、互動邏輯、流程控制）
   - 設計 L1-L4 結果分層呈現的完整邏輯（揭示順序、互動方式、動畫策略）

4. **邏輯設計**
   - 設計 RiskOverride Middleware/Interceptor 的完整邏輯（避免 FOUC）
   - 設計資料流與狀態管理的完整方案

**產出格式**：
- SPEC-1: 技術架構設計文件（Architecture Design Document）
- SPEC-2: 資料結構規格（Data Structure Specification）
- SPEC-4: Stage 2 羅盤組件規格（Component Specification）
- SPEC-5: Risk 邏輯與結果呈現規格（Logic Specification）

### 5.2 技術方案發散與細節補齊（Gemini 的主要責任）

**請以「技術實現顧問」的視角**，在 GPT 的技術架構基礎上，進行實作細節補齊：

1. **實作指南編寫**
   - 將抽象的技術規格轉化為具體的實作步驟
   - 提供程式碼結構建議與命名規範
   - 提供關鍵演算法的偽代碼或實作思路

2. **技術風險識別**
   - 識別潛在的技術風險（性能、相容性、可維護性、可擴展性）
   - 提供風險對策與緩解方案
   - 評估風險對 MVP Gate 驗收的影響

3. **測試策略設計**
   - 設計 6 項 MVP Gate 的測試用例
   - 設計絕對紅線的測試驗證方法
   - 設計單元測試、整合測試、E2E 測試策略

**產出格式**：
- SPEC-3: 實作指南（Implementation Guide）
- SPEC-6: 技術風險評估（Technical Risk Assessment）
- SPEC-7: 測試策略（Testing Strategy）

### 5.3 共同產出要求

**無論是 GPT 還是 Gemini，都應產出以下內容**：

1. **完整且詳細的技術規格**
   - 不得有「待確定」「待討論」的模糊地帶
   - 必須提供明確的技術規格或實作指南
   - 必須確保 Cursor 可直接依此實作（無需額外猜測）

2. **符合專案約束與絕對紅線**
   - 所有技術規格必須符合 UMIP 規格
   - 所有技術規格必須符合絕對紅線（互動、數據遮罩、安全）
   - 所有技術規格必須通過 6 項 MVP Gate 的驗收

3. **可追溯與可審計**
   - 所有技術規格必須有明確的決策依據（引用技術規格結案包、UMIP 結案報告等）
   - 所有技術方案必須說明其優劣與適用場景
   - 所有技術風險必須有對策與緩解方案

4. **可修改與可回滾**
   - 所有技術規格必須標註「可修改」「可回滾」
   - 所有技術決策必須說明其影響範圍與回滾方式
   - 所有技術方案必須支援後續迭代與優化

---

## 六、必須產出的規格文件清單（詳細要求）

### 6.1 SPEC-1: 技術架構設計文件

**文件位置**：`P0-5/P0-5_TECHNICAL_ARCHITECTURE.md`

**必須包含**：

1. **整體架構圖**
   - 組件層級架構（UI Components、Engine、Adapters、Assets）
   - 資料流架構（Compiled Facet JSON → Adapter → ViewModel → Components）
   - 狀態管理架構（Global State、Local State、Flow State）

2. **Adapter Pattern 詳解**
   - Adapter 的職責與邊界
   - 資料轉換邏輯（如何將 Compiled Facet JSON 轉換為 ViewModel）
   - ViewModel 結構設計（Clean Props、封裝內部資料）
   - Adapter 與 Component 的介面定義

3. **資料流設計**
   - 完整資料流圖（從 JSON 載入到 UI 渲染的完整流程）
   - 資料轉換點說明（每個轉換點的輸入輸出）
   - 錯誤處理流程（Fail-soft 機制、降級策略）

4. **狀態管理設計**
   - Global State 管理（Zustand Store 結構：`locale`, `themeResolved`, `riskResolved`）
   - Local State 管理（Component 內部狀態）
   - Flow State 管理（流程狀態，不得存入 Global Store）
   - 狀態更新觸發機制

5. **Stage 1 接口預留機制** ⭐ **重點補充項**
   - **路由接口設計**：
     - Stage 1 → Stage 2 的路由轉換點定義
     - 「直接進入 Stage 2」的入口邏輯設計
     - 未來 Stage 1 實作時的路由銜接方式
   - **資料接口設計**：
     - Stage 1 可能的輸出資料結構（如 `domain_id` 等）
     - Stage 2 的輸入資料結構（是否依賴 Stage 1 的輸出）
     - Stage 1 缺失時的資料處理邏輯（確保 Stage 2 仍可正常運行）
   - **組件接口設計**：
     - Stage 1 組件的 Props 接口定義
     - Stage 1 組件的回調接口（完成後的處理）
     - 未來 Stage 1 組件的整合方式

6. **架構擴展性說明**
   - 如何新增 Facet（更換 JSON，無需修改程式碼）
   - 如何新增 Stage（接口預留機制）
   - 如何擴展主題（`theme_config` 擴展）

**參考資料**：
- 技術規格結案包：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` 第 1 章「核心技術決策」
- UMIP 結案報告：`P0-5/P0-5_UMIP_CLOSURE_REPORT.md` 第 3 章「通用玄學介面架構」
- 工程執行報告：`P0-5/P0-5_IMPLEMENTATION_EXECUTION_REPORT.md` 第 4 章「實作範圍與技術決策」

---

### 6.2 SPEC-2: 資料結構規格

**文件位置**：`P0-5/P0-5_DATA_STRUCTURE_SPEC.md`

**必須包含**：

1. **UMIP Schema v1 完整 JSON Schema 定義**
   - 所有必需欄位（`theme_config`, `risk_level`, `i18n`, L1-L4 敘事結構等）
   - 所有欄位的類型、約束、驗證規則
   - Fail-soft Fallback 行為定義（每個欄位的 fallback 值）
   - JSON Schema 文件（可被工具驗證的格式）

2. **i18n 資料結構設計**
   - CN/EN 雙語組織方式（Key-Value 結構、語言碼定義）
   - 動態文本處理方式（如何處理來自 `compiled_facet.json` 的動態文本）
   - 原生語感保證機制（如何確保英文非逐字翻譯）
   - i18n 資料結構範例

3. **`theme_config` 結構設計**
   - 隱喻 ID (`metaphor_id`) 定義
   - 視覺資產 (`assets`) 結構（背景、粒子、邊框等）
   - 字體與配色 (`typography`) 結構
   - 容錯機制（缺失時的 fallback 值）
   - Neutral Ritual Skin 的定義與使用

4. **至少 2 組完整的範例 JSON**
   - **範例 A：Normal Risk**（正常風險等級）
     - 完整的 `compiled_facet.json` 結構
     - 包含 `theme_config`, `risk_level`, `i18n`, L1-L4 敘事
     - 驗證通過的 JSON Schema
   - **範例 B：High Risk**（高風險等級）
     - 完整的 `compiled_facet.json` 結構（含 `risk_level: HIGH`）
     - 包含安全模板（Template A/B）
     - 驗證通過的 JSON Schema

5. **資料結構擴展性說明**
   - 如何新增欄位（版本控制、向後相容）
   - 如何擴展 `theme_config`（新增隱喻類型）
   - 如何擴展 i18n（新增語言）

**參考資料**：
- 技術規格結案包：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` 第 3 章「D1: UMIP UI Schema」
- UMIP 結案報告：`P0-5/P0-5_UMIP_CLOSURE_REPORT.md` 第 3 章「資料驅動視覺」、第 4 章「Stage 規格」、第 5 章「結果呈現規格」
- 現有 Schema：`schemas/compiled_facet.schema.json`（需擴展）

---

### 6.3 SPEC-3: 實作指南

**文件位置**：`P0-5/P0-5_IMPLEMENTATION_GUIDE.md`

**必須包含**：

1. **目錄結構設計**（D2）
   - `ui/` 目錄的完整結構設計
     - `adapters/`：資料轉換層
     - `components/`：UI 組件層
     - `engine/`：核心引擎（i18nManager, ThemeEngine, RiskOverride）
     - `assets/`：靜態資源
     - `styles/`：樣式文件
     - `types/`：TypeScript 類型定義
   - 每個目錄的職責說明
   - 與 `prototype/` 的關係說明（參考 vs 遷移）

2. **i18n 實作指南**（D4）
   - 即時切換方案（不 reload 的實現方式）
     - 狀態管理方案（Zustand Store 中的 `locale`）
     - 組件更新機制（如何讓所有組件響應語言切換）
     - 動態文本更新邏輯
   - 原生語感保證機制
     - 如何組織 CN/EN 雙語內容（Key-Value 結構）
     - 如何確保英文非逐字翻譯（獨立內容資產，不依賴機器翻譯）
   - 實作步驟與程式碼結構建議
   - 關鍵演算法的偽代碼或實作思路

3. **Theme Engine 實作指南**（D5）
   - `theme_config` 讀取與解析邏輯
     - 如何從 `compiled_facet.json` 讀取 `theme_config`
     - 如何解析 `theme_config` 結構
     - 如何應用 `theme_config` 到 UI
   - 容錯與降級機制（Fail-soft 實現）
     - 缺失 `theme_config` 時的處理邏輯
     - 視覺資產載入失敗時的處理邏輯
     - Neutral Ritual Skin 的應用方式
   - 視覺皮層與敘事結構的隔離策略
     - 如何確保 `theme_config` 僅控制視覺皮層
     - 如何確保視覺變化不影響敘事結構與文字內容
   - 實作步驟與程式碼結構建議
   - 關鍵演算法的偽代碼或實作思路

4. **專案初始化步驟**
   - React + Vite 專案建立步驟
   - 依賴安裝清單（Zustand、SVG 相關庫等）
   - 目錄結構建立步驟
   - 基本配置檔案（Vite config、TypeScript config 等）

**參考資料**：
- 技術規格結案包：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` 第 3 章「D2, D4, D5」
- 工程執行報告：`P0-5/P0-5_IMPLEMENTATION_EXECUTION_REPORT.md` 第 4 章「核心交付物」
- 現有原型代碼：`prototype/app.js`（可作為參考，需重構）

---

### 6.4 SPEC-4: Stage 2 羅盤組件規格

**文件位置**：`P0-5/P0-5_COMPONENT_SPEC_COMPASS.md`

**必須包含**：

1. **SVG 結構設計**（D3）
   - 放射狀/同心圓布局算法
     - 符碼分布算法（20-30 個符碼如何分布在 3-5 層同心圓軌道上）
     - 符碼位置計算公式（極坐標轉換）
     - 符碼間距與密度控制
   - SVG 元素結構（`<svg>`, `<g>`, `<circle>`, `<text>` 等）
   - 符碼資料結構（如何從 `compiled_facet.json` 讀取符碼）
   - 符碼視覺樣式配置（圖示、顏色、動畫）

2. **互動邏輯設計**
   - 點擊邏輯（如何檢測符碼點擊、如何處理點擊事件）
   - 選取邏輯（如何標記已選符碼、如何限制選取數量 2-3 個）
   - 吸附邏輯（符碼如何飛入/吸附至中央太極區）
   - 確認邏輯（選取完成後如何進入 Stage 3）

3. **RWD 適配方案**
   - **桌面端**：完整羅盤顯示（SVG 尺寸、視窗適應）
   - **手機端**：旋盤/撥動模式（可撥動轉輪、單手操作）
   - **平板端**：中間尺寸適配
   - 響應式斷點定義
   - 觸控事件處理（Touch events、手勢識別）

4. **動畫策略**
   - 符碼點亮動畫（點擊後如何點亮）
   - 符碼飛入動畫（如何從軌道位置飛入中央）
   - 符碼吸附動畫（如何吸附至中央太極區）
   - 轉場動畫（進入 Stage 3 的動畫）

5. **絕對紅線檢查**
   - 如何確保「無任何問卷化控件」（無 Grid、List、Form 元素）
   - 如何確保「儀式感互動」（凝視、直覺選擇）
   - 如何確保「非量化暗示」（無數值評分、進度條等）

**參考資料**：
- 技術規格結案包：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` 第 3 章「D3: Stage 2 萬象羅盤」
- UMIP 結案報告：`P0-5/P0-5_UMIP_CLOSURE_REPORT.md` 第 4 章「Stage 2：萬象定物象」
- P0-4.5 分流系統設計：`P0-4.5/P0-4.5_FUNNEL_SYSTEM_DESIGN.md` 第 3 章「Stage 2: 六親定物象」

---

### 6.5 SPEC-5: Risk 邏輯與結果呈現規格

**文件位置**：`P0-5/P0-5_LOGIC_SPEC_RISK_RESULT.md`

**必須包含**：

1. **RiskOverride Middleware/Interceptor 邏輯設計**（D6）
   - 攔截邏輯詳細設計
     - Adapter 解析資料後，Risk Interceptor 的執行時機
     - `risk_level` 檢測邏輯（如何判斷 `risk_level = HIGH`）
     - 攔截點位置（在 Adapter 之後、Store 更新之前）
   - 覆蓋行為詳細設計
     - 如何強制丟棄原 L4 建議
     - 如何寫入靜態安全模板（Template A/B）
     - Template A/B 的管理與選擇邏輯（如何選擇使用哪個模板）
   - 防止閃爍機制（FOUC 避免）
     - 如何確保動態 L4 內容在 HIGH 狀態下從未進入 UI State
     - 如何確保 Store 中只有安全模板內容
   - 實作步驟與程式碼結構建議
   - 關鍵演算法的偽代碼或實作思路

2. **L1-L4 結果分層揭示邏輯**（D7）
   - 揭示順序鎖定邏輯（L1 → L2 → L3 → L4）
     - 如何確保揭示順序不可變更
     - 每個層級的揭示條件
   - L3 主動揭示機制
     - 互動方式設計（點擊/長按/展開）
     - 「撥霧」隱喻的視覺表現
     - 隱藏與顯示的狀態管理
   - 高風險鎖定機制
     - 當 `risk_level = HIGH` 時，L4 如何強制顯示安全模板
     - 動態 L4 的完全忽略邏輯
   - 動畫策略（分層展開、揭示節奏）
     - L1 全螢幕背景氛圍變化動畫
     - L2 核心視覺焦點動畫
     - L3 次級資訊層展開動畫
     - L4 籤詩/錦囊卡片呈現動畫

3. **Stage 3 投射定歸因詳細技術規格** ⭐ **重點補充項**
   - **投射卡片元件設計**：
     - 卡片結構（標題區域、選項區域、確認按鈕區域）
     - 題目資料結構（如何從 `compiled_facet.json` 讀取題目）
       - 題目的 `id`, `text`, `type`, `options` 等欄位
       - 題目的 i18n 處理（CN/EN 切換）
     - 選項呈現方式（圖像、文字、狀態描述等）
       - 選項的資料結構（`id`, `label`, `visual_id`, `description` 等）
       - 選項的視覺樣式（如何符合「象/狀態」要求）
   - **互動邏輯設計**：
     - 單選 vs 多選判斷（根據題目的 `type` 欄位）
     - 選項點擊/選擇邏輯（如何標記已選選項、如何處理取消選擇）
     - 答案收集與暫存（如何暫存答案、答案的資料結構）
     - 轉場動畫（卡片切換、選項確認等）
       - 題目切換動畫（當前題目退出、下一題目進入）
       - 選項選擇動畫（選項點擊反饋、選中狀態視覺）
   - **流程控制設計**：
     - 題目順序（是否允許跳題、如何控制順序）
     - 完成判斷（何時進入 Stage 4、完成條件）
     - 答案提交時機（完成所有題目後提交，或逐題提交）
     - 答案資料結構（如何組織答案、如何傳遞給評分引擎）
   - **RWD 適配**：
     - 桌面端卡片呈現（卡片尺寸、位置、布局）
     - 手機端卡片呈現（是否需要全屏、觸控優化）
     - 平板端適配（中間尺寸、觸控與滑鼠雙支援）
   - **絕對紅線檢查**：
     - 無數值評分（不得出現 1-10、0%-100% 等）
     - 無問卷化控件（不得出現 checkbox、radio button 等傳統表單元素）
     - 確保「直覺選擇（象/狀態）」的互動方式（選項必須是「描述一個狀態」或「選擇一個畫面」）
     - 如何確保選項呈現符合「儀式感互動」要求

**參考資料**：
- 技術規格結案包：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` 第 3 章「D6, D7」、第 6 章「Stage 3 投射定歸因規格補充」
- UMIP 結案報告：`P0-5/P0-5_UMIP_CLOSURE_REPORT.md` 第 4 章「Stage 3：投射定歸因」、第 5 章「結果頁面呈現規格」
- 高風險模板：`P0-3/R2_METAPHOR_BOUNDARY_BANLIST_HIGHRISK_TEMPLATES.md` 第 4 章「R4 高風險觸發：L4 固定模板」

---

### 6.6 SPEC-6: 技術風險評估

**文件位置**：`P0-5/P0-5_TECHNICAL_RISKS.md`

**必須包含**：

1. **技術風險清單**
   - **性能風險**：
     - Stage 2 羅盤 SVG 渲染性能（20-30 個符碼的渲染開銷）
     - 手機端性能（觸控事件處理、動畫流暢度）
     - i18n 即時切換性能（大量文字更新）
   - **相容性風險**：
     - 瀏覽器相容性（SVG、Touch Events、CSS 特性）
     - 裝置相容性（桌面、平板、手機的觸控/滑鼠支援）
   - **可維護性風險**：
     - Adapter Pattern 的複雜度（資料轉換邏輯的維護成本）
     - 主題切換機制的複雜度（`theme_config` 的擴展性）
   - **可擴展性風險**：
     - 新增 Facet 的擴展成本（更換 JSON 的影響範圍）
     - 新增 Stage 的擴展成本（接口預留機制的有效性）
   - **實作風險**：
     - 羅盤退化成問卷的風險（如何確保不會退化成問卷化 UI）
     - 英文敘事失真的風險（如何確保原生語感）
     - 高風險漏蓋的風險（如何確保 RiskOverride 機制可靠）
     - 主題破圖/缺字的風險（如何確保 Fail-soft 機制有效）

2. **對策與緩解方案**
   - 針對每個風險的具體對策
   - 技術實現層面的緩解措施
   - 驗收層面的驗證方法

3. **風險對 MVP Gate 驗收的影響評估**
   - 每個風險對 6 項 MVP Gate 的潛在影響
   - 風險發生時的應對策略
   - 風險對專案進度的影響評估

**參考資料**：
- 技術規格結案包：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` 第 7 章「執行順序與風險控管」
- 工程執行報告：`P0-5/P0-5_IMPLEMENTATION_EXECUTION_REPORT.md` 第 7 章「執行順序與風險控管」

---

### 6.7 SPEC-7: 測試策略

**文件位置**：`P0-5/P0-5_TESTING_STRATEGY.md`

**必須包含**：

1. **6 項 MVP Gate 的測試用例設計**（D8）
   - **Gate #1：資料串接**
     - 測試用例：正常 JSON 載入、缺失欄位處理、錯誤 JSON 處理
     - 驗證方法：DOM Snapshot、Store 序列化檢查、Network Payload 匯出
     - 驗收證據要求
   - **Gate #2：CN/EN 即時切換**
     - 測試用例：語言切換、所有文字更新、原生語感驗證
     - 驗證方法：無 Reload 錄影、文字同步切換確認
     - 驗收證據要求
   - **Gate #3：Stage 2 羅盤**
     - 測試用例：SVG 結構驗證、符碼選取、手機端操作
     - 驗證方法：SVG 結構截圖、手機單手操作錄影
     - 驗收證據要求
   - **Gate #4：L1–L4 呈現**
     - 測試用例：揭示順序、L3 主動揭示、DOM 檢查
     - 驗證方法：揭示順序錄影、DOM 檢查
     - 驗收證據要求
   - **Gate #5：高風險覆蓋**
     - 測試用例：HIGH 狀態觸發、L4 安全模板顯示、動態 L4 忽略
     - 驗證方法：HIGH 狀態下僅顯示安全模板（截圖證明）
     - 驗收證據要求
   - **Gate #6：視覺解耦**
     - 測試用例：主題切換、錯誤處理、Neutral Skin 回退
     - 驗證方法：修改 JSON → UI 換膚（對照圖）、錯誤 → Neutral Skin（對照圖）
     - 驗收證據要求

2. **絕對紅線的測試驗證方法**
   - **互動紅線測試**：
     - 如何驗證「無問卷化控件」（DOM 檢查、結構分析）
     - 如何驗證「無數值評分」（文字檢查、視覺檢查）
   - **數據遮罩紅線測試**：
     - 如何驗證「無內部計算值外洩」（DOM 檢查、Store 檢查、Network Payload 檢查、Console Log 檢查）
   - **安全紅線測試**：
     - 如何驗證「高風險必須覆蓋」（HIGH 狀態測試、DOM 檢查）

3. **測試策略**
   - **單元測試**：
     - Adapter 層的單元測試（資料轉換邏輯）
     - Engine 層的單元測試（i18nManager, ThemeEngine, RiskOverride）
     - Component 層的單元測試（組件邏輯）
   - **整合測試**：
     - Adapter → ViewModel → Component 的整合測試
     - 狀態管理整合測試（Global State 更新、組件響應）
   - **E2E 測試**：
     - 完整流程測試（Stage 2 → Stage 3 → Stage 4）
     - 6 項 MVP Gate 的 E2E 驗證

4. **測試工具與環境**
   - 測試框架選擇（Jest, Vitest, Testing Library 等）
   - E2E 測試工具（Playwright, Cypress 等）
   - 測試環境設定（Mock 資料、Test Fixtures）

**參考資料**：
- 技術規格結案包：`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md` 第 5 章「6 項 MVP Gate」、第 3 章「D8: 驗收報告模板」
- UMIP 結案報告：`P0-5/P0-5_UMIP_CLOSURE_REPORT.md` 第 6 章「P0-5 最小可交付合格線」
- 工程執行報告：`P0-5/P0-5_IMPLEMENTATION_EXECUTION_REPORT.md` 第 6 章「6 項 MVP Gate 的工程化檢核定義」

---

## 七、關鍵技術約束與絕對紅線（必須遵守）

### 7.1 絕對紅線（任何違反皆視為 Bug）

**詳細說明見技術規格結案包第 4 章「絕對紅線與工程約束」**：

#### 互動紅線 (Interaction Red Lines)
- ❌ 禁止問卷化、量化暗示
- ✅ 必須：凝視、直覺選擇、儀式感互動

#### 數據遮罩紅線 (Data Masking)
- ❌ 禁止：前端記憶體、DOM、Network Payload、Console Log、Error Reporting 中出現內部計算值
- ✅ 僅允許：封裝後的 `narrative_text`、`visual_id`

#### 安全紅線 (Safety Protocols)
- ❌ 禁止：`risk_level = HIGH` 時顯示動態生成的 L4
- ✅ 必須：強制顯示靜態安全模板（Template A/B）

### 7.2 技術約束（必須符合）

**詳細說明見技術規格結案包第 1 章「核心技術決策」**：

- ✅ Component-Based Architecture（組件化架構）
- ✅ Adapter Pattern（必須）
- ✅ React + Vite（預設，可替換但需 ADR）
- ✅ Zustand（約束，Global State 僅限 `locale`, `themeResolved`, `riskResolved`）
- ✅ SVG 為 Stage 2 核心渲染技術（已鎖定）

---

## 八、參考資料與文件索引

### 8.1 權威設計文件（必須參考）

1. **`P0-5/P0-5_TECHNICAL_SPEC_CLOSURE_PACK.md`** v1.0
   - 技術規格結案包（絕對權威依據）
   - 包含核心技術決策、驗收標準、絕對紅線、7 份規格文件清單

2. **`P0-5/P0-5_UMIP_CLOSURE_REPORT.md`** v1.0
   - UMIP v1.0 結案報告（Stage 1-4 基本規格、L1-L4 結果呈現規格）

3. **`P0-5/P0-5_IMPLEMENTATION_EXECUTION_REPORT.md`** v3.0
   - 工程執行報告（8 個交付物、執行順序、風險控管）

4. **`P0-5/P0-5_UI_ARCHITECTURE.md`**
   - UI 架構設計（Layer 0-6 架構、技術立場、資料流設計）

5. **`P0-5/P0-5_UI_INTEGRATION_SPEC.md`**
   - UI 串接規格（UI 角色定位、全流程模組分層）

### 8.2 相關設計文件（上下文參考）

1. **`P0-4.5/P0-4.5_FUNNEL_SYSTEM_DESIGN.md`**
   - 4-Stage 分流系統設計（Stage 設計參考）

2. **`P0-3/R2_METAPHOR_BOUNDARY_BANLIST_HIGHRISK_TEMPLATES.md`**
   - 高風險模板定義（Template A/B 參考）

3. **`schemas/compiled_facet.schema.json`**
   - 基本 Schema（需擴展為 UMIP Schema v1）

4. **`domain/compiled/stress_recovery.compiled.v1.0.json`**
   - 範例 Compiled Facet（資料結構參考，需擴展）

5. **`prototype/app.js`**
   - 現有原型代碼（邏輯參考，需重構）

### 8.3 治理文件（確保符合規範）

1. **`docs/governance/CURSOR_FILE_PLACEMENT_RULE.md`**
   - 文件放置規範（產出文件必須符合）

2. **`docs/governance/CURSOR_GPT_GEMINI_COLLABORATION_FRAMEWORK.md`**
   - 協作框架（任務包格式參考）

---

## 九、產出要求與交付格式

### 9.1 產出文件要求

**必須產出以下 7 份規格文件**：

| ID | 文件位置 | 文件名稱 | 狀態 |
| --- | --- | --- | --- |
| **SPEC-1** | `P0-5/P0-5_TECHNICAL_ARCHITECTURE.md` | 技術架構設計文件 | ⏳ 待產出 |
| **SPEC-2** | `P0-5/P0-5_DATA_STRUCTURE_SPEC.md` | 資料結構規格 | ⏳ 待產出 |
| **SPEC-3** | `P0-5/P0-5_IMPLEMENTATION_GUIDE.md` | 實作指南 | ⏳ 待產出 |
| **SPEC-4** | `P0-5/P0-5_COMPONENT_SPEC_COMPASS.md` | Stage 2 羅盤組件規格 | ⏳ 待產出 |
| **SPEC-5** | `P0-5/P0-5_LOGIC_SPEC_RISK_RESULT.md` | Risk 邏輯與結果呈現規格（含 Stage 3） | ⏳ 待產出 |
| **SPEC-6** | `P0-5/P0-5_TECHNICAL_RISKS.md` | 技術風險評估 | ⏳ 待產出 |
| **SPEC-7** | `P0-5/P0-5_TESTING_STRATEGY.md` | 測試策略 | ⏳ 待產出 |

**特別說明**：
- **SPEC-5 必須包含 Stage 3 投射定歸因詳細技術規格**（重點補充項）
- **SPEC-1 必須包含 Stage 1 接口預留機制設計**（重點補充項）

### 9.2 產出格式要求

**所有產出文件必須**：

1. **符合文件放置規範**
   - 放置在 `P0-5/` 目錄下
   - 檔案名稱符合規範（見上）

2. **標註版本與狀態**
   - 版本號：v1.0
   - 狀態：ACTIVE | EDITABLE | REFERENCE（非硬性、可隨時修正）

3. **包含可追溯性聲明**
   - 說明與上游文件的對齊關係（技術規格結案包、UMIP 結案報告、工程執行報告等）
   - 說明技術規格的決策依據

4. **包含可修改與可回滾聲明**
   - 明確標註所有技術規格「可修改」「可回滾」
   - 說明影響範圍與回滾方式

5. **包含實作驗證標準**
   - 每個技術規格都必須有明確的驗證標準
   - 確保 Cursor 可以驗證實作是否符合規格

### 9.3 產出完整性檢查清單

**產出前請確認**：

- [ ] 所有 7 份規格文件都已產出
- [ ] SPEC-1 包含 Stage 1 接口預留機制設計
- [ ] SPEC-5 包含 Stage 3 投射定歸因詳細技術規格
- [ ] 所有技術規格都符合絕對紅線與技術約束
- [ ] 所有技術規格都確保能通過 6 項 MVP Gate 驗收
- [ ] 所有技術規格都包含明確的實作指南或驗證標準
- [ ] 所有產出文件都符合文件放置規範與格式要求

---

## 十、結語與期待

### 10.1 本次任務的重要性

**本次技術規格文件補充任務是 P0-5 技術規格設計階段的關鍵補充**：

- **上游**：技術規格結案包已通過審核，核心決策已明確
- **當前**：需要將基本規格深化為詳細、可執行的技術規格文件
- **下游**：技術規格文件將直接成為 Cursor 工程實作的詳細技術指南

**技術規格文件的品質將直接影響**：
- 工程實作的效率與品質
- MVP Gate 驗收的順利程度
- 後續迭代與優化的可維護性

### 10.2 對 GPT 的期待

**請以「技術架構師」的視角**，深化技術規格：

- **架構設計深化**：產出 SPEC-1（整體架構、Adapter 詳解、Stage 1 接口預留機制）
- **資料結構設計**：產出 SPEC-2（UMIP Schema v1 完整定義、i18n 結構、`theme_config` 結構）
- **組件規格設計**：產出 SPEC-4（Stage 2 羅盤組件完整規格）
- **邏輯設計**：產出 SPEC-5（RiskOverride 邏輯、L1-L4 揭示順序、**Stage 3 詳細技術規格**）

### 10.3 對 Gemini 的期待

**請以「技術實現顧問」的視角**，補齊實作細節：

- **實作指南編寫**：產出 SPEC-3（目錄結構、i18n 實作指南、Theme Engine 實作指南）
- **技術風險識別**：產出 SPEC-6（技術風險清單、對策與緩解方案）
- **測試策略設計**：產出 SPEC-7（6 項 MVP Gate 測試用例、絕對紅線測試驗證方法）

### 10.4 共同期待

**無論是 GPT 還是 Gemini，都應產出**：

1. **完整且詳細的技術規格**（無模糊地帶，可直接依此實作）
2. **符合專案約束與絕對紅線**（通過驗收）
3. **可追溯與可審計**（有決策依據）
4. **可修改與可回滾**（支援迭代）

**期待最終產出**：
- 7 份完整的技術規格文件，供 Cursor 直接依此實作
- Stage 3 投射定歸因的詳細技術規格，確保實作時有明確指引
- Stage 1 接口預留機制的設計，確保未來可擴展

---

**本任務包確認完畢，可交付 GPT 與 Gemini 進行技術規格文件補充。**

**任務包建立日期**：2026-01-10  
**任務包版本**：v1.0  
**任務包狀態**：ACTIVE | EDITABLE | REFERENCE（非硬性、可隨時修正）

