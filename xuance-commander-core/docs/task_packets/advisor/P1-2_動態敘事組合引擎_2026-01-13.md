# P1-2：動態敘事組合引擎任務包

**建立日期**：2026-01-13  
**優先級**：🟡 **HIGH**（高優先級）  
**預估時間**：8-10 天  
**狀態**：READY FOR EXECUTION

---

## 🎯 終極目標 (North Star)

**世界級產品目標**：
- 提供「scary accurate」（令人驚訝的準確）的心理診斷
- 純玄學外觀：使用易經 64 卦作為敘事包裝
- 絕對科學內核：64 卦的選擇是決定性的、可審計的
- **當頭棒喝的洞察**：直指核心問題，讓使用者「被看見」
- **個人化共鳴**：用情境描述讓用戶對號入座

**本任務包目標**：
建立 **動態敘事組合引擎（Dynamic Narrative Combination Engine）**，讓系統能根據使用者的個人情境（六親物象 Context），動態調整卦象敘事，實現「準到發毛」的個人化體驗。

---

## 📋 任務清單

### 核心任務（3 個子任務）

**任務 1：Context 插入點設計**
- 在 64 個卦象敘事中標記 5-10 個插入點
- 定義插入規則和優先級

**任務 2：敘事片段庫建立**
- 為 5 種 Context 類別建立敘事片段
- 每類 10-15 個片段（共 50-75 個片段）

**任務 3：組合規則引擎**
- 設計組合邏輯（卦象 + Context → 個人化敘事）
- 建立組合規則 JSON 檔案

---

## 📚 完整背景資料

### 1. 系統架構：雙層一體式（v3.1）

**檔案位置**：`docs/ops/analysis/東方玄學_現代心理診斷系統_最終架構結案報告_v3.1.md`

#### 架構說明

**Layer 1：Core Diagnostic Engine（診斷引擎）**
- **功能**：科學的分數計算
- **輸入**：用戶的題目答案
- **輸出**：
  - Primary Domain（八卦領域）
  - Rigidity State（僵固狀態）
  - Agency（能動性）
  - Safety Mode（安全模式）

**Layer 2：Derived Insight & Solution Layer（解決方案引擎）**
- **功能**：玄學敘事包裝 + 解決方案生成
- **輸入**：Layer 1 的診斷結果 + Context（六親物象）
- **輸出**：
  - **Hexagram Narrative（卦象敘事）** ← 本任務關注
  - Facet Narrative（面向敘事）
  - Recommendations（解決建議）
  - Riskchains（風險預測）

**重要**：Layer 2 是「單向讀取」Layer 1 的結果，不會反向影響診斷。

---

### 2. 六親物象（Context）系統

**檔案位置**：`engine/solution/context_engine.py`

#### 什麼是六親物象？

六親物象是八字命理中的概念，用於描述使用者與外界的關係類別：

| 類別 | 中文 | 英文 | 象徵 | 範例情境 |
|------|------|------|------|---------|
| **印** | Authority | Authority | 長輩、導師、規則 | 父母、老師、上司、社會規範 |
| **官** | Power | Power | 權威、壓力、責任 | 工作壓力、法律義務、社會期待 |
| **財** | Resource | Resource | 資源、物質、關係 | 金錢、時間、人脈、機會 |
| **比** | Peer | Peer | 同儕、競爭、合作 | 朋友、同事、競爭對手 |
| **食** | Output | Output | 創造、表達、產出 | 創作、溝通、影響力、成就 |

#### Context 如何獲得？

**方法 1：用戶輸入**（簡單版）
- 在診斷開始時，詢問用戶當前主要困擾的關係類別
- 例如：「你目前最困擾的是什麼？」
  - A. 與長輩/權威的關係（印）
  - B. 工作/責任壓力（官）
  - C. 資源/物質問題（財）
  - D. 人際/競爭關係（比）
  - E. 表達/成就問題（食）

**方法 2：自動推斷**（未來版）
- 根據用戶的八卦領域和 Facet 模式自動推斷
- 例如：坎卦（水） + trust_erosion → 可能與 Authority（印）有關

**本任務採用方法 1**（用戶輸入）

---

### 3. 64 卦象敘事系統（當前狀態）

**當前完成度**：✅ **100%**（P1-1 已完成）

#### 檔案位置

```
domain/narratives/hexagram_*.narrative.v1.0.json
```

**檔案數量**：64 個（完整覆蓋）

#### 現有結構

```json
{
  "hexagram_id": "hex_01",
  "name_zh": "乾",
  "name_en": "Qian / The Creative",
  "structure": "Heaven over Heaven (乾為天)",
  "narrative": {
    "diagnostic_insight": {
      "zh": "您如龍行於天，氣勢充盈...",
      "en": "You are like a dragon soaring..."
    },
    "action_guidance": {
      "zh": "此時當以柔克剛...",
      "en": "At this moment, use softness..."
    },
    "metaphors": {
      "primary": {
        "zh": "龍行於天",
        "en": "Dragon soaring in the sky"
      }
    },
    "contraindications": [
      "忌過度用力 (Avoid excessive force)"
    ]
  }
}
```

**特點**：
- ✅ 100% 玄學語境
- ✅ 情境描述生動
- ✅ 當頭棒喝的洞察
- ⚠️ **目前是通用敘事，未個人化**

---

### 4. 動態敘事組合的作用

#### 4.1 為什麼需要動態組合？

**問題**：
- 當前卦象敘事是通用的（例如「乾卦」的敘事對所有人相同）
- 但使用者的困擾情境千差萬別：
  - 用戶 A：乾卦 + 與老闆的權威衝突（Authority）
  - 用戶 B：乾卦 + 創業資源不足（Resource）
  - 用戶 C：乾卦 + 與同事的競爭（Peer）

**解決方案**：
- 在卦象敘事中插入 **Context-specific 片段**
- 讓敘事「說中」用戶的具體情境

**效果**：
- 從「準確」→「準到發毛」
- 從「當頭棒喝」→「被看見」
- 從「玄學包裝」→「個人化共鳴」

#### 4.2 範例對比

**通用敘事**（當前）：
```
您如龍行於天，氣勢充盈，然此刻陽剛過盛，恐有亢龍之憂。
您的意志如磐石堅定，行動如疾風迅雷，卻忘了張弛有度之理。
局勢雖在您掌握之中，但過度用力，反使氣血逆行，難以持久。
```

**個人化敘事**（P1-2 目標）：

**情境 A：Authority（印）**
```
您如龍行於天，氣勢充盈，然此刻陽剛過盛，恐有亢龍之憂。
[插入] 您與權威的碰撞，並非來自外界的壓制，而是您內在的剛強無法順應天時。
長輩或導師的指引，您視為束縛，卻忘了真正的強者，懂得在必要時低頭。
局勢雖在您掌握之中，但過度用力，反使氣血逆行，難以持久。
```

**情境 B：Resource（財）**
```
您如龍行於天，氣勢充盈，然此刻陽剛過盛，恐有亢龍之憂。
[插入] 您對資源的渴求，已超越了實際需求，變成一種對「掌控感」的執念。
金錢、機會、人脈，您想全數掌握，卻忘了過度囤積，反而堵塞了流動。
局勢雖在您掌握之中，但過度用力，反使氣血逆行，難以持久。
```

**效果**：
- ✅ 保留原有的玄學美學
- ✅ 插入具體情境（Authority / Resource）
- ✅ 讓用戶感到「這說的就是我」

---

## 🎯 任務 1：Context 插入點設計

### 1.1 目標

在 64 個卦象敘事中，標記 **5-10 個插入點**，並定義插入規則。

### 1.2 插入點類型

**插入點類型 A：Situation Context（情境背景）**
- **位置**：diagnostic_insight 的第 2-3 句
- **作用**：說明當前困擾的具體情境
- **範例**：
  ```
  [通用] 您的困擾並非來自外界，而是來自內在無法停歇的驅動力。
  [插入 Authority] 您的困擾並非來自外界的規則，而是您內在無法順應權威的剛強。
  [插入 Resource] 您的困擾並非來自外界的匱乏，而是您內在對資源的過度執著。
  ```

**插入點類型 B：Relational Metaphor（關係隱喻）**
- **位置**：diagnostic_insight 的中段
- **作用**：用隱喻描述與特定 Context 的關係
- **範例**：
  ```
  [通用] 您如磐石堅定，卻忘了張弛有度之理。
  [插入 Authority] 您如磐石堅定，與長輩的衝撞，如水拍巖石，激起千層浪花。
  [插入 Peer] 您如磐石堅定，與同儕的較量，如山爭高下，誰也不肯退讓。
  ```

**插入點類型 C：Actionable Direction（行動方向）**
- **位置**：action_guidance 的開頭
- **作用**：針對特定 Context 給出方向性建議
- **範例**：
  ```
  [通用] 此時當以柔克剛，學會收斂鋒芒。
  [插入 Authority] 此時當以柔克剛，面對權威時，學會低頭不是認輸，而是智慧。
  [插入 Resource] 此時當以柔克剛，面對資源時，學會放手不是放棄，而是流動。
  ```

### 1.3 插入規則設計

**規則 1：優先級**
- 如果用戶提供了 Context，則插入 Context-specific 片段
- 如果用戶未提供 Context，則使用通用敘事

**規則 2：插入密度**
- 每個卦象敘事：插入 2-3 個片段
- 避免過度插入（保持整體流暢性）

**規則 3：語氣一致性**
- 插入片段的語氣、風格、玄學詞彙，必須與原敘事一致
- 避免突兀感

### 1.4 輸出格式

**檔案名稱**：`hexagram_context_insertion_points.v1.0.json`

**結構範例**：
```json
{
  "hexagram_01_qian": {
    "insertion_points": [
      {
        "id": "hex_01_insert_1",
        "location": "diagnostic_insight",
        "position": "after_sentence_2",
        "type": "situation_context",
        "template": "您的困擾並非來自外界，而是{{context_specific_clause}}。",
        "context_clauses": {
          "authority": "您內在無法順應權威的剛強",
          "power": "您內在無法承受壓力的緊繃",
          "resource": "您內在對資源的過度執著",
          "peer": "您內在無法接受輸贏的執念",
          "output": "您內在對成就的過度追求"
        }
      },
      {
        "id": "hex_01_insert_2",
        "location": "diagnostic_insight",
        "position": "middle",
        "type": "relational_metaphor",
        "template": "您如磐石堅定，{{context_specific_metaphor}}。",
        "context_metaphors": {
          "authority": "與長輩的衝撞，如水拍巖石，激起千層浪花",
          "power": "與責任的角力，如山承重壓，幾近崩塌",
          "resource": "與資源的纏鬥，如磁石吸鐵，無法鬆手",
          "peer": "與同儕的較量，如山爭高下，誰也不肯退讓",
          "output": "與成就的追逐，如箭離弦，無法回頭"
        }
      },
      {
        "id": "hex_01_insert_3",
        "location": "action_guidance",
        "position": "opening",
        "type": "actionable_direction",
        "template": "此時當以柔克剛，{{context_specific_action}}。",
        "context_actions": {
          "authority": "面對權威時，學會低頭不是認輸，而是智慧",
          "power": "面對壓力時，學會卸下不是逃避，而是調節",
          "resource": "面對資源時，學會放手不是放棄，而是流動",
          "peer": "面對競爭時，學會合作不是妥協，而是共贏",
          "output": "面對成就時，學會放緩不是懈怠，而是持久"
        }
      }
    ]
  }
}
```

### 1.5 交付物

1. ✅ **插入點設計檔案**（1 個）
   - `hexagram_context_insertion_points.v1.0.json`
   - 包含 64 個卦象的插入點定義

2. ✅ **設計文檔**（1 個）
   - `CONTEXT_INSERTION_DESIGN.md`
   - 說明插入邏輯、規則、範例

**總計**：2 個檔案

---

## 🎯 任務 2：敘事片段庫建立

### 2.1 目標

為 5 種 Context 類別（Authority, Power, Resource, Peer, Output），建立 **10-15 個敘事片段**，供動態組合使用。

### 2.2 片段類別

**類別 A：Situation Context Clauses（情境背景句）**
- **作用**：描述與特定 Context 的關係狀態
- **長度**：10-20 字
- **範例**：
  ```json
  {
    "authority": [
      "您內在無法順應權威的剛強",
      "您與長輩的關係如逆水行舟",
      "您對規則的反抗已成為枷鎖",
      "您渴望認可，卻拒絕臣服"
    ]
  }
  ```

**類別 B：Relational Metaphors（關係隱喻）**
- **作用**：用玄學隱喻描述關係動態
- **長度**：15-30 字
- **範例**：
  ```json
  {
    "resource": [
      "與資源的纏鬥，如磁石吸鐵，無法鬆手",
      "對金錢的渴求，如乾涸之地渴望甘霖",
      "資源在手，卻如握沙，越緊越流失",
      "機會來臨，您如餓虎撲食，反而嚇走獵物"
    ]
  }
  ```

**類別 C：Actionable Directions（行動方向句）**
- **作用**：針對特定 Context 給出方向性建議
- **長度**：15-30 字
- **範例**：
  ```json
  {
    "peer": [
      "面對競爭時，學會合作不是妥協，而是共贏",
      "與同儕的較量中，放下輸贏，才能看見更大的局",
      "競爭如風，順應則輕盈，對抗則疲憊",
      "同行者非敵人，而是鏡子，映照出你的盲點"
    ]
  }
  ```

### 2.3 片段設計原則

**原則 1：玄學語境**
- ✅ 使用五行、氣、勢、局等詞彙
- ✅ 使用隱喻和象徵
- ❌ 避免心理學/醫療詞彙

**原則 2：情境對號入座**
- ✅ 描述具體情境（Authority / Resource / Peer...）
- ✅ 讓用戶感到「這說的就是我」
- ❌ 避免抽象空泛

**原則 3：語氣一致性**
- ✅ 溫和、理解、不評判
- ✅ 玄學詩意
- ❌ 避免說教、指責

**原則 4：可組合性**
- ✅ 每個片段都能獨立使用
- ✅ 片段之間能順暢組合
- ❌ 避免邏輯衝突

### 2.4 輸出格式

**檔案結構**：

```json
{
  "context_fragments": {
    "authority": {
      "situation_clauses": [
        "您內在無法順應權威的剛強",
        "您與長輩的關係如逆水行舟",
        "您對規則的反抗已成為枷鎖",
        "您渴望認可，卻拒絕臣服",
        "權威在您眼中，是牢籠而非指引",
        "長輩的期待，如山壓頂，讓您喘不過氣",
        "您渴望自由，卻困在對權威的憤怒中",
        "您的反骨，是力量也是負擔",
        "上位者的壓力，已化為您內在的怨氣",
        "您與規則的對抗，消耗了原本的創造力"
      ],
      "relational_metaphors": [
        "與長輩的衝撞，如水拍巖石，激起千層浪花",
        "權威如山，您如樹，想要突破天際，卻被壓制",
        "導師的指引，您視為束縛，如鳥拒絕籠子",
        "規則如網，您如魚，掙扎越烈，纏繞越緊",
        "上位者的命令，如風吹火，您越燒越旺",
        "長輩的期待，如重擔，壓彎了您的脊梁",
        "您與權威的關係，如劍與盾，永無止境的碰撞",
        "父母的愛，您視為控制，如影子揮之不去",
        "社會規範，在您眼中是枷鎖，而非秩序",
        "您對權威的不信任，如毒藥，侵蝕了內心"
      ],
      "actionable_directions": [
        "面對權威時，學會低頭不是認輸，而是智慧",
        "權威不是敵人，而是鏡子，映照出您的盲點",
        "放下對權威的憤怒，才能看見他們的善意",
        "順應規則，不是失去自由，而是獲得秩序",
        "與長輩和解，不是妥協，而是成熟",
        "權威如水，順應則流動，對抗則翻騰",
        "導師的指引，是燈塔，而非牢籠",
        "學會在權威面前低頭，才能在人生路上抬頭",
        "規則是框架，而非束縛，掌握它，才能超越它",
        "放下對上位者的敵意，內在的能量才能回流"
      ]
    },
    "power": {
      "situation_clauses": [...],
      "relational_metaphors": [...],
      "actionable_directions": [...]
    },
    "resource": {
      "situation_clauses": [...],
      "relational_metaphors": [...],
      "actionable_directions": [...]
    },
    "peer": {
      "situation_clauses": [...],
      "relational_metaphors": [...],
      "actionable_directions": [...]
    },
    "output": {
      "situation_clauses": [...],
      "relational_metaphors": [...],
      "actionable_directions": [...]
    }
  }
}
```

### 2.5 交付物

1. ✅ **敘事片段庫**（5 個檔案，每個 Context 一個）
   - `context_fragments_authority.v1.0.json`（Authority - 印）
   - `context_fragments_power.v1.0.json`（Power - 官）
   - `context_fragments_resource.v1.0.json`（Resource - 財）
   - `context_fragments_peer.v1.0.json`（Peer - 比）
   - `context_fragments_output.v1.0.json`（Output - 食）

2. ✅ **整合檔案**（1 個）
   - `context_fragments_complete.v1.0.json`（包含所有 5 個類別）

3. ✅ **文檔說明**（1 個）
   - `CONTEXT_FRAGMENTS_README.md`

**總計**：7 個檔案

---

## 🎯 任務 3：組合規則引擎

### 3.1 目標

設計組合邏輯，讓系統能根據 **卦象 + Context** 動態生成個人化敘事。

### 3.2 組合邏輯

**輸入**：
- Hexagram ID（例如：hex_01）
- Context Type（例如：authority）

**處理**：
1. 讀取卦象的原始敘事
2. 讀取卦象的插入點定義
3. 讀取 Context 的敘事片段
4. 根據插入點規則，將片段插入原始敘事

**輸出**：
- 個人化敘事（包含 Context-specific 片段）

### 3.3 組合規則範例

**規則文件結構**：

```json
{
  "combination_rules": {
    "version": "1.0",
    "rules": [
      {
        "rule_id": "rule_01",
        "name": "Situation Context Insertion",
        "description": "在 diagnostic_insight 的第 2-3 句插入情境背景句",
        "priority": 1,
        "conditions": {
          "context_provided": true,
          "insertion_point_exists": true
        },
        "action": {
          "type": "insert",
          "location": "diagnostic_insight",
          "position": "after_sentence_2",
          "fragment_type": "situation_clauses",
          "selection_method": "random"
        }
      },
      {
        "rule_id": "rule_02",
        "name": "Relational Metaphor Insertion",
        "description": "在 diagnostic_insight 的中段插入關係隱喻",
        "priority": 2,
        "conditions": {
          "context_provided": true,
          "insertion_point_exists": true
        },
        "action": {
          "type": "insert",
          "location": "diagnostic_insight",
          "position": "middle",
          "fragment_type": "relational_metaphors",
          "selection_method": "random"
        }
      },
      {
        "rule_id": "rule_03",
        "name": "Actionable Direction Insertion",
        "description": "在 action_guidance 的開頭插入行動方向句",
        "priority": 3,
        "conditions": {
          "context_provided": true,
          "insertion_point_exists": true
        },
        "action": {
          "type": "insert",
          "location": "action_guidance",
          "position": "opening",
          "fragment_type": "actionable_directions",
          "selection_method": "random"
        }
      }
    ]
  }
}
```

### 3.4 交付物

1. ✅ **組合規則檔案**（1 個）
   - `narrative_combination_rules.v1.0.json`

**總計**：1 個檔案

---

## 📦 交付物總結

### 總檔案數：10 個

**任務 1：Context 插入點設計**（2 個檔案）
1. `hexagram_context_insertion_points.v1.0.json`
2. `CONTEXT_INSERTION_DESIGN.md`

**任務 2：敘事片段庫建立**（7 個檔案）
3. `context_fragments_authority.v1.0.json`
4. `context_fragments_power.v1.0.json`
5. `context_fragments_resource.v1.0.json`
6. `context_fragments_peer.v1.0.json`
7. `context_fragments_output.v1.0.json`
8. `context_fragments_complete.v1.0.json`
9. `CONTEXT_FRAGMENTS_README.md`

**任務 3：組合規則引擎**（1 個檔案）
10. `narrative_combination_rules.v1.0.json`

---

## ✅ 驗收標準

### 必須達成

1. ✅ **10 個檔案全部交付**
2. ✅ **所有 JSON 檔案格式正確**
3. ✅ **100% 玄學語境**（0% 心理學/醫療詞彙）
4. ✅ **所有片段中英雙語**
5. ✅ **所有片段可組合**（無邏輯衝突）

### 品質標準

1. ✅ **情境對號入座**：用戶感到「這說的就是我」
2. ✅ **語氣一致性**：插入片段與原敘事無突兀感
3. ✅ **玄學美學**：文字優美流暢，富有詩意
4. ✅ **實用性**：組合規則清晰，易於實作

---

## 🎯 成功指標

### 量化指標

- ✅ 64 個卦象插入點定義完成
- ✅ 5 個 Context × 3 個類別 × 10 個片段 = 150 個片段
- ✅ 10 個檔案全部交付
- ✅ 100% 玄學語境（0% 違規詞彙）

### 質化指標

- ✅ 個人化程度提升（從「準確」→「準到發毛」）
- ✅ 情境共鳴增強（用戶感到「被看見」）
- ✅ 玄學美學保持（不損失原有的詩意）

---

## 📂 相關文件索引

### 核心文件（必讀）

1. `domain/narratives/hexagram_*.narrative.v1.0.json`  
   → 64 個卦象的原始敘事（P1-1 已完成）

2. `docs/ops/analysis/東方玄學_現代心理診斷系統_最終架構結案報告_v3.1.md`  
   → 系統總體架構

3. `domain/knowledge_base/vocabulary_metaphysical.v1.0.json`  
   → 玄學詞彙白名單

4. `docs/task_packets/executor/P1-1_完成總結_2026-01-13.md`  
   → P1-1 完成報告（64 卦敘事）

### 參考文件（選讀）

5. `engine/solution/context_engine.py`  
   → Context 引擎實作（技術參考）

6. 易經原文（外部資源）  
   → 理解卦象本義

---

## 🚀 開始執行

### 建議執行流程

**第 1-2 天**：熟悉背景
- 閱讀 64 卦敘事（P1-1 成果）
- 理解六親物象系統
- 理解動態組合的目的

**第 3-4 天**：任務 1（插入點設計）
- 分析 64 個卦象的結構
- 標記插入點位置
- 設計插入規則

**第 5-7 天**：任務 2（敘事片段庫）
- 為 Authority 建立 10-15 個片段
- 為 Power 建立 10-15 個片段
- 為 Resource 建立 10-15 個片段
- 為 Peer 建立 10-15 個片段
- 為 Output 建立 10-15 個片段

**第 8-9 天**：任務 3（組合規則引擎）
- 設計組合邏輯
- 建立規則 JSON

**第 10 天**：審核、優化、整合、測試

### 關鍵注意事項

⚠️ **絕對禁止**：
- ❌ 使用現代心理學詞彙（焦慮、憂鬱、壓力等）
- ❌ 使用醫療診斷詞彙（治療、症狀、疾病等）
- ❌ 空泛建議（多休息、放鬆心情等）
- ❌ 突兀的插入（損害原敘事的流暢性）

✅ **必須遵守**：
- ✅ 100% 玄學語境
- ✅ 情境對號入座（具體描述 Context）
- ✅ 語氣一致性（插入片段與原敘事無縫融合）
- ✅ 文字優美流暢

---

**建立日期**：2026-01-13  
**優先級**：🟡 HIGH  
**預估時間**：8-10 天  
**交付期限**：建議 2026-01-23 前完成  
**執行者**：顧問團隊（R1/R2/R4）  
**審核者**：總指揮（Cursor）
