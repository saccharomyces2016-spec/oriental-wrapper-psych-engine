# P0-5 網頁狀態詳細報告

**報告日期**：2026-01-11  
**狀態**：⚠️ **需要修復編譯錯誤後才能運行**  
**優先級**：P0（阻斷主線）

---

## 一、執行摘要

### 當前狀態
- ✅ **代碼結構**：完整（38 個 TypeScript 文件）
- ✅ **JSON 資料**：`compiled_facet.json` 結構完整
- ❌ **編譯狀態**：**TypeScript 編譯失敗**（38 個錯誤）
- ❓ **運行狀態**：無法運行（需先修復編譯錯誤）

### 核心問題
1. **TypeScript 類型錯誤**：`facetAdapter.ts` 中對 `RawUmipJson` 類型訪問錯誤（27 個錯誤）
2. **未使用變數警告**：多處未使用的導入和變數（11 個警告）
3. **類型定義不匹配**：`safetyTemplateId` 類型不匹配（1 個錯誤）

---

## 二、預期外觀狀態

### 2.1 整體架構
根據 `P0-5_UMIP_CLOSURE_REPORT.md`，網頁應採用：

- **架構模式**：Pure Renderer Architecture（前端僅負責渲染，不包含領域邏輯）
- **狀態管理**：Zustand (全局) + React Context (流式狀態)
- **技術棧**：React 18 + TypeScript + Vite

### 2.2 Stage 2：萬象羅盤（Radial Compass）

**預期外觀**：
- 放射狀羅盤／星盤介面（Radial Symbol Map）
- 盤面呈現 **20–30 個微縮符碼**（例：印、官、財、煞、馬、權、情、緣、傷、貴…）
- 符碼分布於**同心圓軌道**上（3–5 層軌道：INNER、MIDDLE、OUTER）
- SVG 渲染（不可用 Canvas）
- 中央太極區用於顯示選取的符碼

**操作邏輯**：
- 指令：「凝視盤面，點擊此刻映入眼簾的 3 個徵兆。」
- 點擊後符碼點亮，並吸附/飛入中央太極區
- 確認按鈕：選取完成後進入 Stage 3

**RWD 適配**：
- 桌面端：完整羅盤顯示
- 手機端：可撥動轉輪/旋盤模式
- 平板端：適配中間尺寸

### 2.3 Stage 3：投射定歸因（Projection）

**預期外觀**：
- 投射卡片，**一題一頁**（One Screen, One Query）
- 題目以卡片形式呈現
- 選項為按鈕形式（狀態/畫面/象的描述，不得包含數值評分）
- 不允許捲動式長問卷

**操作邏輯**：
- 顯示當前問題
- 選擇答案後自動進入下一題
- 最後一題完成後進入 Stage 4

### 2.4 Stage 4：命盤綜合與斷語（Results）

**預期外觀**：

**L1：天象／定調**
- 全螢幕背景氛圍變化
- 同 Band ≥3 組天象描述隨機輪播
- 標題形式呈現

**L2：物象／主敘事**
- 核心視覺焦點
- 使用高銳利度名詞（如裂痕、發霉、潰決）
- 自動揭示（L2AutoAfterMs 後自動顯示）

**L3：干擾／盲點**
- 次級資訊層
- 需使用者主動互動才揭示（點擊/長按/展開）
- 隱喻「撥霧」

**L4：姿態／儀式**
- 籤詩/錦囊式卡片
- 語氣必須是「宜… / 不宜… / 守… / 攻…」
- **高風險鎖定**：當 `risk_level = HIGH` 時鎖定 L4，顯示安全模板

### 2.5 語言切換

**預期功能**：
- 右上角語言切換按鈕（中文/EN）
- 即時切換，不需重新載入頁面（no reload）
- 所有文字（題目、結果、按鈕、UI 標籤）都需即時更新
- 英文敘事需具原生語感（不得逐字翻譯腔）

---

## 三、功能狀態

### 3.1 已實作功能

| 功能模組 | 狀態 | 說明 |
|---------|------|------|
| **適配器層（Adapter）** | ⚠️ 部分完成 | 代碼存在，但類型錯誤導致無法編譯 |
| **Stage 2 組件** | ⚠️ 部分完成 | RadialCompass 組件存在，但無法運行 |
| **Stage 3 組件** | ⚠️ 部分完成 | Stage3Page 組件存在，但無法運行 |
| **Stage 4 組件** | ⚠️ 部分完成 | ResultStage 組件存在，但無法運行 |
| **i18n 引擎** | ⚠️ 部分完成 | i18nManager 代碼存在，但無法運行 |
| **主題引擎** | ⚠️ 部分完成 | ThemeEngine 代碼存在，但無法運行 |
| **風險覆蓋** | ⚠️ 部分完成 | RiskOverride 代碼存在，但無法運行 |
| **狀態管理** | ✅ 完成 | FlowStateProvider 和 Zustand store 代碼完整 |

### 3.2 編譯錯誤詳情

#### 類型錯誤（27 個）

**位置**：`src/adapters/facetAdapter.ts`

**問題**：TypeScript 無法正確推斷 `RawUmipJson` 的嵌套類型

**具體錯誤**：
1. `symbol_id` / `id` 屬性訪問錯誤（第 147 行）
2. `label_key` 屬性訪問錯誤（第 148 行）
3. `svg_ref` 屬性訪問錯誤（第 149 行）
4. `track` 屬性訪問錯誤（第 150 行）
5. `initial_angle` 屬性訪問錯誤（第 151 行）
6. `question_id` / `id` 屬性訪問錯誤（第 174 行）
7. `title_key` 屬性訪問錯誤（第 175 行）
8. `prompt_key` 屬性訪問錯誤（第 176 行）
9. `question_type` 屬性訪問錯誤（第 177 行）
10. `options` 屬性訪問錯誤（第 178 行）
11. `option_id` / `id` 屬性訪問錯誤（第 179 行）
12. `image_ref` 屬性訪問錯誤（第 181 行）
13. `scene_key` 屬性訪問錯誤（第 182 行）
14. `title_key` / `body_key` 屬性訪問錯誤（多處，L1/L2/L3/L4）

**根本原因**：
- `RawUmipJson` 類型定義中的嵌套類型被推斷為 `never`
- 需要明確類型斷言或調整類型定義

#### 類型不匹配錯誤（1 個）

**位置**：`src/engine/risk/interceptor.ts`（第 71 行）

**問題**：`safetyTemplateId` 類型不匹配
- 期望類型：`"TEMPLATE_A" | "TEMPLATE_B" | undefined`
- 實際類型：`string`

#### 未使用變數警告（11 個）

- `safeBoolean`（facetAdapter.ts:21）
- `React` 導入（多處）
- `svgRef`（SymbolGlyph.tsx:34）
- `safetyTemplateId`（L4Action.tsx:33）
- `state`（Stage2Page.tsx:29, Stage3Page.tsx:31）

---

## 四、流程狀態

### 4.1 預期流程

根據 `P0-5_UMIP_CLOSURE_REPORT.md`，預期流程為：

```
1. 應用啟動
   ↓
2. 載入 compiled_facet.json
   ↓
3. Adapter 轉換為 ViewModel
   ↓
4. Stage 2：萬象羅盤（符碼選擇）
   - 使用者選擇 2-3 個符碼
   - 點擊確認按鈕
   ↓
5. Stage 3：投射定歸因（問題回答）
   - 逐一顯示問題（一題一頁）
   - 使用者選擇答案
   - 最後一題完成後自動進入 Stage 4
   ↓
6. Stage 4：命盤綜合與斷語（結果呈現）
   - L1 自動顯示（天象）
   - L2 自動顯示（物象，延遲後）
   - L3 使用者主動揭示（干擾）
   - L4 顯示（姿態/儀式，高風險時強制安全模板）
```

### 4.2 當前流程狀態

| 流程步驟 | 狀態 | 說明 |
|---------|------|------|
| **應用啟動** | ❌ 無法啟動 | 編譯錯誤導致無法運行 |
| **資料載入** | ⚠️ 代碼存在 | `useFacetData` hook 存在，但無法測試 |
| **Adapter 轉換** | ❌ 編譯失敗 | `facetAdapter.ts` 類型錯誤 |
| **Stage 2** | ❌ 無法運行 | 組件存在但無法編譯 |
| **Stage 3** | ❌ 無法運行 | 組件存在但無法編譯 |
| **Stage 4** | ❌ 無法運行 | 組件存在但無法編譯 |
| **語言切換** | ❌ 無法測試 | 功能代碼存在但無法運行 |
| **風險覆蓋** | ❌ 無法測試 | 功能代碼存在但無法運行 |

---

## 五、與 P0-5 規格的對比

### 5.1 MVP Gate 驗收標準對比

根據 `P0-5_IMPLEMENTATION_EXECUTION_REPORT.md`，6 項 MVP Gate 驗收標準：

| Gate | 標準 | 當前狀態 | 說明 |
|------|------|---------|------|
| **G1** | 資料串接 | ❌ 無法驗收 | 編譯錯誤導致無法測試 |
| **G2** | CN/EN 即時切換 | ❌ 無法驗收 | 功能代碼存在但無法運行 |
| **G3** | Stage 2 儀式介面 | ❌ 無法驗收 | RadialCompass 組件存在但無法運行 |
| **G4** | L1-L4 結果呈現 | ❌ 無法驗收 | ResultStage 組件存在但無法運行 |
| **G5** | 高風險覆蓋 | ❌ 無法驗收 | RiskOverride 代碼存在但無法運行 |
| **G6** | 視覺解耦 | ❌ 無法驗收 | ThemeEngine 代碼存在但無法運行 |

**總結**：**0/6 通過**（無法驗收，需先修復編譯錯誤）

### 5.2 絕對紅線檢查

根據 `P0-5_UMIP_CLOSURE_REPORT.md` 第 2 章：

| 紅線類型 | 檢查項 | 當前狀態 | 說明 |
|---------|--------|---------|------|
| **互動紅線** | 一屏一問 | ⚠️ 待驗證 | Stage 3 代碼符合，但無法運行驗證 |
| **互動紅線** | 禁止量化暗示 | ⚠️ 待驗證 | 代碼中無明顯違規，但需運行驗證 |
| **互動紅線** | 具象化選項 | ⚠️ 待驗證 | 代碼中選項為 labelKey，需運行驗證 |
| **數據遮罩紅線** | 前端不可接收敏感資料 | ✅ 符合 | Adapter 已遮罩敏感欄位 |
| **數據遮罩紅線** | 僅供顯影 | ✅ 符合 | ViewModel 結構正確 |
| **安全與合規紅線** | 高風險強制覆蓋 | ⚠️ 待驗證 | RiskOverride 代碼存在，但無法運行驗證 |
| **安全與合規紅線** | 非指令化呈現 | ⚠️ 待驗證 | 代碼結構符合，但需運行驗證 |

---

## 六、需要修復的問題

### 6.1 優先級 P0（阻斷編譯）

1. **修復 TypeScript 類型錯誤**
   - 位置：`src/adapters/facetAdapter.ts`
   - 問題：`RawUmipJson` 類型推斷失敗
   - 解決方案：調整類型定義或使用類型斷言

2. **修復類型不匹配錯誤**
   - 位置：`src/engine/risk/interceptor.ts`
   - 問題：`safetyTemplateId` 類型不匹配
   - 解決方案：確保類型正確

### 6.2 優先級 P1（清理警告）

3. **清理未使用變數**
   - 移除未使用的導入
   - 移除未使用的變數
   - 或使用下劃線前綴標記為有意未使用

### 6.3 優先級 P2（驗證功能）

4. **運行測試**
   - 啟動開發伺服器
   - 測試 Stage 2/3/4 流程
   - 測試語言切換
   - 測試風險覆蓋

5. **驗收測試**
   - 逐項驗收 6 個 MVP Gate
   - 記錄驗收結果
   - 修復發現的問題

---

## 七、建議的修復順序

1. **第一步**：修復 TypeScript 編譯錯誤（P0）
   - 調整 `RawUmipJson` 類型定義
   - 修復 `facetAdapter.ts` 中的類型訪問
   - 修復 `interceptor.ts` 中的類型不匹配

2. **第二步**：清理警告（P1）
   - 移除未使用的導入和變數

3. **第三步**：運行測試（P2）
   - 啟動開發伺服器
   - 測試基本流程

4. **第四步**：功能驗收（P2）
   - 驗收 6 個 MVP Gate
   - 修復發現的問題

---

## 八、文件引用

- **結案報告**：`P0-5/P0-5_UMIP_CLOSURE_REPORT.md`
- **執行報告**：`P0-5/P0-5_IMPLEMENTATION_EXECUTION_REPORT.md`
- **完成報告**：`P0-5/P0-5_IMPLEMENTATION_COMPLETION_REPORT.md`
- **Schema 定義**：`schemas/umip_schema_v1.json`
- **JSON 資料**：`ui/public/data/compiled_facet.json`

---

**報告版本**：v1.0  
**狀態**：待修復編譯錯誤
