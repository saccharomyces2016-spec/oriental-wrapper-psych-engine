# P0-4.5 多階段分流系統設計規格 (Holographic Funnel System)

**文件狀態**：ACTIVE | EDITABLE（可修改，保留後續調整權）
**版本**：v1.0.0
**日期**：2026-01-10
**適用範圍**：全人類、全年齡、全困擾
**設計性質**：架構決策（Architectural Decision）

---

## 1. 系統目標 (System Goals)

建立一套「純玄學外觀、科學內核」的分流系統，使任何使用者可在短流程內，從模糊困擾被收斂至單一、可解析、可計費的 Facet。

**核心原則**：
1.  **全覆蓋 (Universal Coverage)**：全程不產生「沒有符合選項」的體驗。
2.  **單一出口 (Single Exit)**：最終必須收斂至單一 Facet (One Session, One Problem)。
3.  **高解析度 (High Granularity)**：必須能區分相同領域下的不同心理歸因與具體情境。

---

## 2. 總體架構：4-Stage Holographic Funnel

系統採用四階段全像漏斗，缺一不可：

| 階段 | 名稱 | 核心功能 | 資訊維度 |
| :--- | :--- | :--- | :--- |
| **Stage 1** | **八卦定方位** (The Domain Gate) | 鎖定大領域，建立付費邊界 | **Where** (哪裡痛) |
| **Stage 2** | **六親定物象** (The Context Lock) | 鎖定具體人事物，避免抽象歸因 | **Who/What** (局中何物) |
| **Stage 3** | **萬象定歸因** (The Attribution Matrix) | 診斷歸因模式與能動性 | **Why** (為何而痛) |
| **Stage 4** | **綜合斷語** (Synthesis & Routing) | 產出洞察與路由 | **Insight** (洞察與路徑) |

---

## 3. 詳細規格 (Stage Specifications)

### Stage 1: 八卦定方位 (The Domain Gate)
* **目的**：初步分流，確立諮詢主題。
* **互動形式**：強制單選 (Single Choice)。
* **隱喻介面**：八卦轉輪 (Ba Gua Wheel) 或 八門卡片。
* **硬規則**：
    * 必須包含 **「中宮 / 混沌 (Chaos)」** 作為兜底入口。
    * 一次僅鎖定一個領域，禁止複選。
* **數據輸出**：
    ```json
    { "domain_id": "BAGUA_CODE" } // e.g., KUN (Career), XUN (Relationship)
    ```

### Stage 2: 六親定物象 (The Context Lock)
* **目的**：鎖定具體人事物，解決「有痛感但無對象」的問題。
* **理論基礎**：八字六親 (Six Relations) → 抽象化符號。
* **互動形式**：符號雲 / 物象群 (Symbol Cloud)。
* **操作方式**：多選 2–3 項（憑直覺，不需理解含義）。
* **物象分類表**：
    1.  **Authority (印)**：長輩、規範、契約、制度、高牆。
    2.  **Power (官)**：責任、壓力、考試、法則、枷鎖。
    3.  **Resource (財)**：金錢、目標、慾望、資源、獵物。
    4.  **Peer (比)**：同儕、競爭者、合作夥伴、影子。
    5.  **Output (食)**：子女、作品、表現、情緒出口、花果。
* **數據輸出**：
    ```json
    {
      "context_items": ["AUTHORITY_SYMBOL", "POWER_SYMBOL"]
    }
    ```

### Stage 3: 萬象定歸因 (The Attribution Matrix)
* **目的**：診斷使用者的歸因慣性（Locus of Control）與能動性（Agency）。
* **互動形式**：萬象羅盤 / 星盤 (Phenomenon Compass)。
* **操作方式**：投射式選擇（單選或少量多選）。
* **歸因軸向 (Attribution Axis)**：
    * **外部・不可控** (Fate)：宿命、劫數、天意。
    * **外部・情境** (Context)：小人、羅網、時勢。
    * **內部・不足** (Deficit)：無力、迷惘、空虛（能力/資源不足）。
    * **內部・過度** (Overload)：執著、心魔、自苦（責任/認知過載）。
* **能動軸向 (Agency Axis)**：Low / Medium / High。
* **數據輸出**：
    ```json
    {
      "attribution_profile": {
        "locus": "INTERNAL",
        "subtype": "OVERLOAD",
        "agency_level": "HIGH"
      }
    }
    ```

### Stage 4: 命盤綜合與斷語 (Synthesis & Routing)
* **目的**：生成「當頭棒喝」的洞察並導向 Facet。
* **生成規則**：
    1.  **比例化描述**：指出「責任分佈失衡」（如：七分在天，三分在人）。
    2.  **必引物象**：斷語中必須包含 Stage 2 選中的具體符號（如：「您被『高牆』所困...」）。
    3.  **矛盾揭露**：若 Stage 2 與 Stage 3 存在衝突（如：選了「宿命」卻又「執著」），必須點出。
    4.  **去病理化**：禁止使用焦慮、憂鬱等現代心理學名詞。
* **數據輸出**：
    ```json
    {
      "diagnosis_insight": "String (Metaphysical Narrative)",
      "target_facet_id": "income_expansion_pressure" // or relationship_imbalance
    }
    ```

---

## 4. 路由規則 (Routing Rules)

1.  **精確路由**：
    * 若 S1=坤 (Career) + S2=Resource/Power → 導向 `income_expansion_pressure`。
    * 若 S1=巽 (Relationship) + S2=Peer/Output → 導向 `relationship_imbalance`。
2.  **模糊路由 (Fuzzy Routing)**：
    * 若 S1=中宮 (Chaos)，則根據 S2 與 S3 的權重，由演算法判定導向最接近的 Facet，或進入通用安撫流程。
3.  **擴充性**：
    * 新增 Facet 時，僅需定義其在 S1 與 S2 的映射區間，無需修改整體架構。

---

## 5. 驗收標準 (Success Criteria)

1.  **完整性**：使用者必須能順暢完成 4 個階段，無斷點。
2.  **準確性**：生成的斷語必須能反映使用者在 S2 (物象) 與 S3 (心態) 的選擇。
3.  **體驗感**：UI 與文案必須維持純玄學風格，不得出現問卷感。
4.  **單一性**：最終結果頁面必須明確指向單一付費解鎖項目。

---

## 6. 與現有系統的整合

### 6.1 與 Facet 的整合
- Stage 4 完成後，系統導向對應的 Facet（如 `income_expansion_pressure` 或 `relationship_imbalance`）
- 進入 Facet 後，執行該 Facet 的題目問答流程（即原 P0-5 設計的 Layer 3: Question Walk）
- Facet 題目問答完成後，進入結果呈現（即原 P0-5 設計的 Layer 5: Narrative Stage）

### 6.2 與 P0-5 UI 架構的整合
- **Stage 1-3** 對應 P0-5 UI 架構的 **Layer 2: Facet Gate**（擴充版）
- **Stage 4** 對應 **Layer 3: Question Walk** 的入口判斷
- **Facet 題目問答** 對應 **Layer 3: Question Walk**
- **結果呈現** 對應 **Layer 5: Narrative Stage**

### 6.3 數據流整合
```
Stage 1 (Domain) + Stage 2 (Context) + Stage 3 (Attribution)
        ↓
Stage 4 (Synthesis & Routing)
        ↓
target_facet_id
        ↓
Facet Question Walk (Layer 3)
        ↓
Result Presentation (Layer 5)
```

---

## 7. 八卦盤界面整合方案

### 7.1 Stage 1: 八卦轉輪界面
- **界面類型**：八卦轉輪 (Ba Gua Wheel) 或 八門卡片
- **互動方式**：單選（必須選擇一個，包含「中宮/混沌」）
- **實現方式**：
  - 可旋轉的八卦盤，使用者選擇一個卦象
  - 或卡片式布局，使用者點擊一個卡片
- **數據收集**：`domain_id` 對應八卦代碼

### 7.2 Stage 2: 符號雲界面
- **界面類型**：符號雲 / 物象群 (Symbol Cloud)
- **互動方式**：多選 2–3 項
- **實現方式**：
  - 符號以雲狀布局呈現
  - 使用者可點擊多個符號
  - 符號可視化為東方玄學意象（如：印=印章、官=官印、財=金元寶等）
- **數據收集**：`context_items` 陣列

### 7.3 Stage 3: 萬象羅盤界面
- **界面類型**：萬象羅盤 / 星盤 (Phenomenon Compass)
- **互動方式**：投射式選擇（單選或少量多選）
- **實現方式**：
  - 羅盤式布局，中心為使用者，四周為歸因選項
  - 使用者可以拖曳或點擊選擇
  - 視覺化為東方玄學星盤意象
- **數據收集**：`attribution_profile` 物件

---

## 8. 題型設計策略總結

| 階段 | 題型 | 互動形式 | 界面類型 | 數據結構 |
|------|------|---------|---------|---------|
| Stage 1 | 單選（強制） | 八卦轉輪 / 八門卡片 | 八卦盤界面 | `domain_id` |
| Stage 2 | 多選（2-3項） | 符號雲 / 物象群 | 符號選擇界面 | `context_items[]` |
| Stage 3 | 投射式選擇（單選/少量多選） | 萬象羅盤 / 星盤 | 羅盤界面 | `attribution_profile{}` |
| Stage 4 | 生成式（系統生成） | 綜合斷語呈現 | 文字敘事 | `diagnosis_insight` + `target_facet_id` |

---

## 9. 擴充性設計

### 9.1 新增 Facet 的擴充流程
1. 定義新 Facet 在 Stage 1 的八卦映射（如：新 Facet 對應「震卦」）
2. 定義新 Facet 在 Stage 2 的物象偏好（如：偏好 Authority 和 Power）
3. 定義新 Facet 在 Stage 3 的歸因特徵（如：常見為 Internal-Overload）
4. 更新路由規則，添加新 Facet 的映射邏輯

### 9.2 界面樣式的擴充
- Stage 1-3 的界面樣式可在 P0-5 之後優化
- 但數據結構和流程邏輯不得改變
- 符合 `P0-5_QUESTION_MODALITY_EXTENSIBILITY.md` 的設計原則

---

## 10. 狀態與版本

- **狀態**：ACTIVE | EDITABLE（可修改，保留後續調整權）
- **版本**：v1.0.0
- **建立日期**：2026-01-10
- **批准者**：總指揮（Cursor）
- **設計者**：副指揮官 + R1/R2 顧問師
- **修改原則**：可根據實際需求調整設計，但需經過審核並更新相關文件
- **參考文件**：
  - `P0-4.5/P0-4.5_CHARTER.md`
  - `docs/gem/briefs/TASK_PACKAGE_P0-4.5_QUESTION_FLOW_FUNNEL_SYSTEM.md`
  - `FULL/NORTH_STAR.md`
  - `docs/domain/design/P0-5_QUESTION_MODALITY_EXTENSIBILITY.md`

