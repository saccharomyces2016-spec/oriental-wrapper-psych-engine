# P0-5.6 易經矩陣系統實作任務包

**任務編號**：P0-5.6  
**任務名稱**：易經矩陣系統實作（I Ching Matrix System Implementation）  
**建立日期**：2026-01-11  
**狀態**：ACTIVE  
**優先級**：P0（阻塞 Phase 1 使用者驗證）

---

## 一、任務概述

### 1.1 任務目標

實作易經矩陣系統（I Ching Matrix System），包括：
1. UMIP v1.1 資料結構擴展（UserProfile、ResultPayload）
2. 核心演算法實作（雙軌運算機制）
3. Facet 內容錨定（income_expansion_pressure ↔ 卦象路徑對照）

### 1.2 任務性質

**功能實作任務**（Engineering Implementation Task）

**輸出交付物**：
- UMIP v1.1 Schema 文件
- 核心演算法實作（代碼）
- Facet 內容錨定對照表
- 測試用例與驗證機制

### 1.3 任務重要性

**阻塞關係**：
- 阻塞：Phase 1（使用者驗證）、P0-5.7 設計的完整實作
- 被阻塞：P0-5.5（系統架構決策）、P0-5.7（世界觀設計）

**理由**：
- 這是 P0-5.5 決策的立即執行項目
- 這是 Phase 0 完成的最後一步（88.9% → 100%）
- 這是後續 Phase 的基礎，不完成無法進入 Phase 1

---

## 二、核心原則（必須遵守）

### 2.1 二元架構原則（核心約束）

**「後端科學極大化，前端玄學極致化」**

這是系統的核心架構原則，必須嚴格遵守：

#### 後端（不可見層）：
- 使用現代心理學與相關科學系統作為核心引擎
- 結構化的數據處理（問卷、評分、風險鏈）
- 可推導的計算邏輯

#### 前端（可見層）：
- 使用者只感知到「完整的玄學系統」
- 使用五行、八卦等東方玄學元素作為表層呈現
- **關鍵**：五行、八卦只能在表層，不能污染現代科學的計算結果

### 2.2 雙重計算原則（關鍵機制）

**⚠️ 核心機制：雙重計算，結果一致**

**關鍵理解**：
- **玄學系統（五行、八卦）也會經過完整的計算**
- **玄學計算結果必須與科學計算結果一致**
- **最終呈現給使用者的是科學計算的正確結果，但以經過確實計算的玄學結果的模樣呈現**

#### 雙重計算流程：

1. **科學計算路徑**（內部驗證基準）：
   - 使用現代科學方法計算（心理學評估、風險分析等）
   - 產出：`Risk_Level`, `Score`, `Scientific_Advice`
   - 地位：**絕對基準 (The Truth)**

2. **玄學計算路徑**（表層呈現系統）：
   - 使用五行生剋與易經卦理進行推演
   - 產出：`Hexagram_ID`, `Element_Tags`, `Metaphysical_Text`
   - 地位：**表層呈現 (The Face)**

3. **結果驗證與一致性檢查**：
   - 比較兩種計算結果
   - 確保玄學計算結果與科學計算結果一致
   - 如果不一致，調整玄學計算邏輯或參數
   - **關鍵**：玄學計算結果必須符合科學計算結果

4. **表層呈現**（使用者看到）：
   - 呈現給使用者的是：**玄學計算結果的模樣**
   - 但這個結果已經過驗證，與科學計算結果一致

#### 關鍵原則：

- 玄學系統不是裝飾，而是真正的計算系統
- 科學計算和玄學計算必須同時進行
- 兩種結果必須一致，科學計算作為驗證基準
- 一致性優先：如果出現不一致，優先以科學計算結果為準

#### 禁止事項（嚴格禁止）：
- ❌ 不得讓玄學計算結果影響科學計算結果
- ❌ 不得為了「看起來像玄學」而犧牲結果的正確性
- ❌ 不得向使用者暴露科學計算過程
- ❌ 不得在科學計算階段使用玄學邏輯（科學計算必須保持純科學）

#### 允許事項：
- ✅ 玄學系統有完整的計算邏輯
- ✅ 科學計算和玄學計算同時進行
- ✅ 兩種計算結果必須一致
- ✅ 呈現給使用者的是玄學計算結果（但已驗證與科學計算一致）
- ✅ 內部保留雙重計算機制和驗證邏輯（供審計與維護，但使用者看不到）

---

## 三、系統架構背景

### 3.1 已確定的系統架構（P0-5.5 決策）

根據 `P0-5.5_ELEMENT_SELECTION_DECISION.md`，系統已確定採用：

**System Canon：易經矩陣系統（I Ching Matrix System）**

#### 系統定義：

> 一套以「八卦／六十四卦」作為狀態空間（Structure / State Space），  
> 以「五行生剋」作為動態解釋層（Dynamics / Interpretation），  
> 以「雙軌輸入（本命 × 流年）」驅動運算與敘事輸出（Dual-Track Engine）  
> 的動態神諭系統（Data-Driven Oracle）。

#### 三層架構：

1. **結構層（The Skeleton）：八卦 / 六十四卦**
   - 角色：狀態空間、人生構面座標、最終局勢符號
   - 輸出：`hexagram_id`（0-63 或 1-64，共 64 個卦象）

2. **動態層（The Blood）：五行生剋**
   - 角色：衝突與修復的解釋邏輯
   - 輸出：`interaction_tags`（例如：generate / control / drain 等內部標籤）

3. **運算層（The Engine）：雙軌制（Root × Flow）**
   - Track A：先天本命（Root / Nature）- DOB → Root Element
   - Track B：後天流年（Flow / Nurture）- Stage 1-3 → Hexagram
   - Collision：`Result = f(Root, Flow)`

### 3.2 雙軌運算機制詳解

#### Track A：先天本命（Root / Nature）

**輸入**：DOB（出生年月日）- **選填**

**計算**：
- 使用干支系統：DOB → 天干地支 → 五行
- 例如：1985-03-15 → 乙丑年 → 木

**容錯**：
- 若使用者不提供 DOB，系統必須以 Stage 1-3 的行為資料推導「後天優勢屬性」作為替代 Root
- 例如：根據使用者的回答推導「傾向於木的屬性」
- **不得中斷流程**

**用途**：
- 身份錨點（「你是這樣的人」）
- 敘事個性化（「作為一個屬木的人...」）

**決策權**：
- Root 僅用於「身份錨點」與「敘事個性化」
- **不得取代 Flow 的決策權**

#### Track B：後天流年（Flow / Nurture）

**輸入**：Stage 1-3 的互動選擇與問卷量表

**計算**：
- Stage 1（八卦選擇）→ 領域定位
- Stage 2（五行選擇）→ 物象定位
- Stage 3（問題回答）→ 歸因分析
- 綜合計算 → Hexagram + Changing Line

**決策權**（強制）：
- 最終建議、風險鏈、行動方案的決策權以 Flow 為準
- Root 僅用於個性化，不影響決策

#### Collision（碰撞運算）

**核心形式**：`Result = f(Root, Flow)`

**用途**：
- 解釋「為何你是這樣的人（Root）」在「此刻遭遇這種局勢（Flow）」時會出現此壓力與風險走向
- 例如：「作為一個屬木的人（Root），在當前金旺的局勢（Flow）下，容易受到克制，產生壓力...」

### 3.3 Stage 1-4 映射（已確定）

根據 P0-5.5 決策和 P0-5.7 設計，Stage 1-4 的映射已確定：

| Stage | 名稱 | UI 隱喻 | 功能 | 狀態 |
|-------|------|---------|------|------|
| **Stage 1** | 八卦定方位 | 先天八卦盤（Primordial Bagua） | 分流選擇（Facet Space 定位） | 設計完成，需實作 |
| **Stage 2** | 五行定物象 | 五行羅盤（Elemental Compass） | 符碼選擇（顯性特徵 / 投射物） | 設計完成，需實作 |
| **Stage 3** | 爻變定歸因 | 鑄爻（Casting Lines） | 量表權重 → 變爻觸發 → 卦象轉移 | 設計完成，需實作 |
| **Stage 4** | 卦象顯影 | 卦象顯影（Hexagram Visualization） | 結果呈現（L1-L4 分層） | 設計完成，需實作 |

---

## 四、立即執行項目詳解（P0-5.5 決策要求）

根據 `P0-5.5_ELEMENT_SELECTION_DECISION.md` 第 8 節「立即執行項目」，本任務包含以下三個核心項目：

### 4.1 UMIP 演進至 v1.1（資料結構）

**目標**：擴展 UMIP Schema 以支持易經矩陣系統

#### 4.1.1 UserProfile 新增欄位

**當前狀態**：UMIP v1.0 未定義 UserProfile

**需要新增**：
```json
{
  "UserProfile": {
    "dob": "string | null",
    "root_element": "enum | null"
  }
}
```

**欄位說明**：
- `dob`（Date of Birth）：出生年月日，格式建議為 ISO 8601（例如：`1985-03-15`）
  - 類型：`string | null`
  - 說明：選填，若未提供則使用 Stage 1-3 的行為資料推導「後天優勢屬性」
- `root_element`（Root Element）：先天本命五行屬性
  - 類型：`enum | null`（值：`"METAL" | "WOOD" | "WATER" | "FIRE" | "EARTH" | null`）
  - 說明：由 DOB 計算得出，或由 Stage 1-3 推導得出

#### 4.1.2 ResultPayload 新增欄位

**當前狀態**：UMIP v1.0 未定義 ResultPayload（結果載荷）

**需要新增**：
```json
{
  "ResultPayload": {
    "hexagram_id": "string | number",
    "changing_line_index": "number | null",
    "root_flow_collision_key": "string"
  }
}
```

**欄位說明**：
- `hexagram_id`（Hexagram ID）：最終卦象 ID
  - 類型：`string | number`
  - 說明：0-63 或 1-64（實作時統一），由 Stage 1-3 推導得出
- `changing_line_index`（Changing Line Index）：變爻索引
  - 類型：`number | null`
  - 說明：0-5（對應六個爻的位置），若無變爻則為 `null`
- `root_flow_collision_key`（Root-Flow Collision Key）：碰撞運算結果鍵
  - 類型：`string`
  - 說明：用於索引碰撞敘事模板（例如：`"wood_gold_conflict"`）

#### 4.1.3 Schema 文件位置

- **當前 Schema**：`schemas/umip_schema_v1.json`
- **新 Schema**：`schemas/umip_schema_v1.1.json`
- **注意**：需要保持向後兼容（UMIP v1.0 的資料仍可正常處理）

### 4.2 核心演算法（最小可行）

**目標**：實作易經矩陣系統的核心計算邏輯

#### 4.2.1 DOB → Root Element（干支/映射器）

**功能**：將出生年月日轉換為五行屬性

**輸入**：
- `dob: string | null`（ISO 8601 格式，例如：`1985-03-15`）

**輸出**：
- `root_element: "METAL" | "WOOD" | "WATER" | "FIRE" | "EARTH" | null`

**容錯規範（強制）**：
- 若 `dob` 為 `null` 或無效，返回 `null`（由 Stage 1-3 推導器處理）
- 若日期解析失敗，返回 `null`

**演算法要求**：
- 使用傳統干支系統（天干地支）計算
- 可參考標準的干支轉換演算法
- 需要支援西曆年份（例如：1985 = 乙丑年）

**實作位置**：
- 建議建立新文件：`engine/root_element_mapper.py` 或類似

#### 4.2.2 Stage 1–3 → Hexagram + Changing Line（推導器）

**功能**：根據使用者的 Stage 1-3 互動選擇，推導出最終卦象和變爻

**輸入**：
- Stage 1 選擇：八卦選擇（例如：`"KUN"` 坤卦）
- Stage 2 選擇：五行選擇（例如：`["WOOD", "FIRE"]`）
- Stage 3 選擇：問題回答（例如：`{q1: "option_a", q2: "option_b"}`）

**輸出**：
- `hexagram_id: number`（0-63 或 1-64）
- `changing_line_index: number | null`（0-5 或 null）

**演算法要求**：
- 需要建立「Stage 1-3 輸入 → 卦象」的映射邏輯
- 需要考慮五行生剋關係
- 需要考慮變爻的觸發條件（例如：特定問題回答組合）
- 需要確保結果與科學計算結果一致（見雙重計算原則）

**實作位置**：
- 建議建立新文件：`engine/hexagram_deriver.py` 或類似

#### 4.2.3 Root × Flow → Collision Narrative Key（模板索引）

**功能**：根據 Root 和 Flow 的組合，生成碰撞敘事鍵

**輸入**：
- `root_element: "METAL" | "WOOD" | "WATER" | "FIRE" | "EARTH" | null`
- `hexagram_id: number`
- `changing_line_index: number | null`

**輸出**：
- `root_flow_collision_key: string`（例如：`"wood_gold_conflict"`）

**演算法要求**：
- 需要建立「Root × Hexagram → Collision Key」的映射表
- 需要考慮五行生剋關係（例如：木被金克 = `"wood_gold_conflict"`）
- 需要考慮卦象屬性（例如：困卦 = 困境）
- Collision Key 用於索引最終的敘事模板

**實作位置**：
- 建議建立新文件：`engine/collision_calculator.py` 或類似

### 4.3 Facet 內容錨定（從既有 facet 開始）

**目標**：建立 `income_expansion_pressure` Facet 與卦象路徑的對照表

#### 4.3.1 對照表結構

**需要建立**：「Facet ↔ 卦象路徑」對照表

**對照關係**：
- Facet 的科學計算結果（Score、Risk Level、Band）→ 對應的卦象（Hexagram ID）
- Facet 的特定問題回答組合 → 對應的變爻（Changing Line Index）

**注意事項**：
- 卦名（如「困」「渙」）可作為敘事素材，但**工程上必須以 `hexagram_id`/key 驅動**
- 避免語言造成耦合與翻譯漂移
- 需要建立可回溯的模板鍵（Traceable Template Keys）

#### 4.3.2 實作要求

**文件位置**：
- 建議建立：`domain/facets/income_expansion_pressure.hexagram_mapping.v1.0.json`

**文件結構**（建議）：
```json
{
  "facetId": "income_expansion_pressure",
  "domainVersion": "1.0",
  "hexagram_mapping": {
    "bands": {
      "low": {
        "hexagram_candidates": [1, 2, 11, ...],
        "default_hexagram_id": 11
      },
      "mid": {
        "hexagram_candidates": [47, 48, ...],
        "default_hexagram_id": 47
      },
      "high": {
        "hexagram_candidates": [47, 29, ...],
        "default_hexagram_id": 47
      }
    },
    "changing_line_triggers": {
      "q1_option_a_q2_option_b": {
        "changing_line_index": 2
      },
      ...
    }
  }
}
```

**驗證要求**：
- 需要確保對照表與科學計算結果一致
- 需要建立測試用例驗證映射正確性

---

## 五、設計約束（P0-5.7 設計要求）

### 5.1 世界觀設計約束

根據 `P0-5.7_DESIGN_DOC_FINAL.md`，實作需要遵守以下設計約束：

1. **Stage 1-4 互動方式定義**：
   - Stage 1：Rotate → Snap → Lock
   - Stage 2：Beam → Select
   - Stage 3：Charge → Release → Result
   - Stage 4：Unroll → Development

2. **基本視覺風格基調**：
   - 色彩系統：Rice Paper White、Ink Black、Cinnabar Red、Bronze Gold、Jade Green、Indigo Blue
   - 字體排印：宋體/明體（儀式性文字）、無襯線黑體（功能性文字）
   - 介面材質：框線、印章、拓印

3. **AI 敘事生成層規範**：
   - AI 是敘事者，不是運算者
   - 本機運算鎖定結果後，投遞給 AI 進行敘事擴寫
   - 必須遵守嚴格約束（禁止重新解卦、禁止修改風險等級、禁止新增建議）

### 5.2 技術約束

1. **必須支持 CN/EN 雙語**：
   - 所有輸出必須支持雙語
   - 不得有語言特定的硬編碼

2. **必須支持 `theme_config` 機制**：
   - 實作需要考慮可配置性
   - 不得硬編碼視覺元素

3. **必須支持 RWD（響應式設計）**：
   - 桌面端、平板端、手機端都要考慮
   - 互動方式需要在不同設備上可用

---

## 六、現有系統背景

### 6.1 當前 Facet：income_expansion_pressure

**定義**：薪資增速追不上家庭開銷所產生的壓力，以及對「第二收入」的驅動與可行性狀態。

**當前狀態**：
- 題目、評分、敘事、建議、風險鏈已建立
- 使用「歲時農耕・倉廩觀」作為 user-facing 隱喻
- 數據結構符合 UMIP v1.0

**注意**：
- 當前 Facet 使用農耕隱喻，但新的系統架構要求使用易經矩陣系統
- 需要在實作中考慮如何整合或轉換

### 6.2 數據結構（UMIP v1.0）

**當前數據結構**：
- `compiled_facet.json` 格式
- 包含 `stage2_compass`、`stage3_projection`、`stage4_results`
- 支持 `theme_config`（視覺配置）
- 支持 `i18n`（CN/EN 雙語）

**當前 Schema**：
- `schemas/umip_schema_v1.json`

**計劃演進**（本任務）：
- UMIP v1.0 → v1.1
- 新增 `dob`、`root_element`、`hexagram_id` 等欄位

### 6.3 現有 UI 實作（P0-5 已完成）

**已實作的 UI 組件**：
- Stage 2：Radial Compass（放射狀羅盤）- 當前使用通用符碼概念
- Stage 3：Projection（投射問題）- 當前使用通用問題框架
- Stage 4：Results（結果呈現）- L1-L4 分層呈現

**需要調整的部分**：
- Stage 2：從通用符碼調整為五行羅盤
- Stage 3：從通用問題調整為鑄爻
- Stage 4：從通用結果調整為卦象顯影
- Stage 1：需要新建（當前未實作）

---

## 七、交付物要求

### 7.1 必交付物

1. **UMIP v1.1 Schema 文件**
   - 文件位置：`schemas/umip_schema_v1.1.json`
   - 內容：包含 UserProfile 和 ResultPayload 的新欄位定義
   - 要求：向後兼容 UMIP v1.0

2. **核心演算法實作（代碼）**
   - DOB → Root Element 映射器（`engine/root_element_mapper.py` 或類似）
   - Stage 1-3 → Hexagram + Changing Line 推導器（`engine/hexagram_deriver.py` 或類似）
   - Root × Flow → Collision Narrative Key 計算器（`engine/collision_calculator.py` 或類似）

3. **Facet 內容錨定對照表**
   - 文件位置：`domain/facets/income_expansion_pressure.hexagram_mapping.v1.0.json`
   - 內容：Facet ↔ 卦象路徑對照

4. **測試用例與驗證機制**
   - 單元測試：每個演算法都需要測試用例
   - 整合測試：驗證雙重計算機制的一致性
   - Golden Tests：固定輸入輸出，確保行為穩定

5. **技術文檔**
   - 演算法說明文檔
   - API 使用說明（如適用）
   - 測試指南

### 7.2 可選交付物

- 演算法優化建議
- 性能分析報告
- 擴展性評估報告

### 7.3 預期時間

- **總預計時間**：2-3 週
- **分解**：
  - UMIP v1.1 Schema：1-2 天
  - 核心演算法實作：1-2 週
  - Facet 內容錨定：2-3 天
  - 測試與驗證：3-5 天

---

## 八、驗收標準

### 8.1 功能驗收

1. **UMIP v1.1 Schema 驗收**：
   - Schema 文件符合 JSON Schema 規範
   - 包含所有必需欄位（UserProfile、ResultPayload）
   - 向後兼容 UMIP v1.0

2. **核心演算法驗收**：
   - DOB → Root Element 映射器：正確處理有效/無效 DOB，返回正確的五行屬性
   - Stage 1-3 → Hexagram + Changing Line 推導器：正確推導卦象和變爻
   - Root × Flow → Collision Narrative Key 計算器：正確生成碰撞鍵

3. **Facet 內容錨定驗收**：
   - 對照表結構正確
   - 映射關係與科學計算結果一致
   - 可回溯的模板鍵有效

4. **雙重計算機制驗收**：
   - 科學計算和玄學計算同時進行
   - 兩種計算結果一致（通過驗證測試）
   - 一致性檢查機制有效

### 8.2 品質驗收

1. **測試覆蓋率**：
   - 單元測試覆蓋率 ≥ 80%
   - 整合測試覆蓋所有主要流程
   - Golden Tests 通過

2. **代碼品質**：
   - 代碼符合專案規範
   - 代碼可讀性良好
   - 代碼可維護性良好

3. **文檔完整性**：
   - 技術文檔完整
   - API 文檔完整（如適用）
   - 測試文檔完整

### 8.3 性能驗收

1. **演算法性能**：
   - DOB → Root Element 映射：< 10ms
   - Stage 1-3 → Hexagram 推導：< 50ms
   - Collision 計算：< 20ms

2. **系統穩定性**：
   - 無記憶體洩漏
   - 無死鎖風險
   - 錯誤處理完善

---

## 九、風險與挑戰

### 9.1 技術風險

1. **雙重計算機制的一致性保證**
   - 風險：玄學計算結果與科學計算結果可能不一致
   - 緩解：建立嚴格的一致性檢查機制，優先以科學計算結果為準

2. **演算法複雜度高**
   - 風險：易經矩陣系統的演算法可能過於複雜
   - 緩解：採用最小可行方案，先實作核心功能，後續再優化

3. **向後兼容性**
   - 風險：UMIP v1.1 可能破壞現有系統
   - 緩解：保持向後兼容，新欄位設為可選

### 9.2 時間風險

1. **實作時間可能超出預期**
   - 風險：核心演算法實作可能需要更多時間
   - 緩解：優先實作最小可行版本，後續迭代優化

2. **測試時間可能不足**
   - 風險：測試用例編寫和驗證可能需要更多時間
   - 緩解：採用測試驅動開發（TDD），邊開發邊測試

### 9.3 品質風險

1. **演算法正確性**
   - 風險：演算法可能包含邏輯錯誤
   - 緩解：建立完善的測試用例，包含邊界情況和異常情況

2. **可維護性**
   - 風險：代碼可能難以維護
   - 緩解：遵循良好的編碼規範，編寫清晰的文檔

---

## 十、相關文件索引

### 10.1 核心決策文件

- **P0-5.5 決策文件**：`P0-5.5_ORIENTAL_ELEMENT_CONSULTATION/P0-5.5_ELEMENT_SELECTION_DECISION.md`
  - 系統架構定義
  - Stage 1-4 映射
  - 雙軌運算機制
  - 立即執行項目（本任務的依據）

- **P0-5.7 設計文檔**：`P0-5.7_WORLDVIEW_DESIGN/P0-5.7_DESIGN_DOC_FINAL.md`
  - 世界觀設計規格
  - Stage 1-4 互動方式定義
  - AI 敘事生成層規範

- **P0-5 UMIP 設計**：`P0-5/P0-5_UMIP_CLOSURE_REPORT.md`
  - UMIP 架構原則
  - 視覺解耦機制
  - Stage 1-4 規格

### 10.2 背景資料文件

- **CHARTER**：`charter/CHARTER.md`
  - 終極目標
  - 核心原則

- **進度分析報告**：`PROGRESS_ANALYSIS_2026-01-11.md`
  - 整體進度分析
  - 任務完成度分析
  - 下一步任務建議

### 10.3 技術文件

- **UMIP Schema v1.0**：`schemas/umip_schema_v1.json`
- **Domain Schema**：`schemas/domain_manifest.schema.json`
- **Compiled Facet Schema**：`schemas/compiled_facet.schema.json`

### 10.4 當前任務文件

- **任務包**：`P0-5.6_ICHING_MATRIX_IMPLEMENTATION/P0-5.6_TASK_PACKET.md`（本文件）

---

## 十一、任務狀態

**當前狀態**：ACTIVE  
**下一步行動**：將本任務包提供給工程師/顧問師，開始實作工作

---

**文件版本**：v1.0  
**最後更新**：2026-01-11
