# P0-5.6 易經矩陣系統實作 - 完整任務包

**文件版本**：v1.0  
**建立日期**：2026-01-11  
**任務編號**：P0-5.6  
**任務名稱**：易經矩陣系統實作（I Ching Matrix System Implementation）

---

## 📋 文件使用說明

本文件是 **P0-5.6 完整任務包**，整合了所有必要的背景資料和任務要求。

**文件結構**：
- **第一部分**：任務概述與核心原則（本文件）
- **第二部分**：詳細技術要求（見 `P0-5.6_ENGINEER_BRIEF.md`）
- **第三部分**：交付清單（見 `P0-5.6_DELIVERY_CHECKLIST.md`）

**建議閱讀順序**：
1. 先閱讀本文件的「一、任務概述」和「二、核心原則」
2. 如需詳細技術要求，請閱讀 `P0-5.6_ENGINEER_BRIEF.md`
3. 開始實作前，請確認 `P0-5.6_DELIVERY_CHECKLIST.md` 中的交付要求

---

## 一、任務概述

### 1.1 任務目標

實作易經矩陣系統（I Ching Matrix System），包括：
1. **UMIP v1.1 資料結構擴展**（UserProfile、ResultPayload）
2. **核心演算法實作**（雙軌運算機制）
3. **Facet 內容錨定**（income_expansion_pressure ↔ 卦象路徑對照）

### 1.2 任務性質

**功能實作任務**（Engineering Implementation Task）

**預估時間**：2-3 週

### 1.3 任務重要性

**阻塞關係**：
- **阻塞**：Phase 1（使用者驗證）、P0-5.7 設計的完整實作
- **被阻塞**：P0-5.5（系統架構決策）、P0-5.7（世界觀設計）

**理由**：
- 這是 P0-5.5 決策的立即執行項目
- 這是 Phase 0 完成的最後一步（88.9% → 100%）
- 這是後續 Phase 的基礎，不完成無法進入 Phase 1

---

## 二、核心原則（必須遵守）

### 2.1 二元架構原則（核心約束）

**「後端科學極大化，前端玄學極致化」**

#### 後端（不可見層）：
- 使用現代心理學與相關科學系統作為核心引擎
- 結構化的數據處理（問卷、評分、風險鏈）
- 可推導的計算邏輯
- **使用者完全看不到這個層級**

#### 前端（可見層）：
- 使用者只感知到「完整的玄學系統」
- 使用五行、八卦等東方玄學元素作為表層呈現
- **關鍵**：五行、八卦只能在表層，不能污染現代科學的計算結果

### 2.2 雙重計算原則（關鍵機制）

**⚠️ 核心機制：雙重計算，結果一致**

#### 關鍵理解：
- **玄學系統（五行、八卦）也會經過完整的計算**
- **玄學計算結果必須與科學計算結果一致**
- **最終呈現給使用者的是科學計算的正確結果，但以經過確實計算的玄學結果的模樣呈現**

#### 雙重計算流程：

1. **科學計算路徑**（內部驗證基準）：
   - 使用者回答題目
   - 系統使用現代科學方法計算（心理學評估、風險分析等）
   - 得到科學計算結果（分數、風險等級、建議等）
   - 這個結果作為「驗證基準」

2. **玄學計算路徑**（表層呈現系統）：
   - 使用者回答題目（與科學計算路徑相同）
   - 系統使用玄學系統計算（五行、八卦、易經邏輯等）
   - 得到玄學計算結果（卦象、五行屬性、玄學建議等）
   - **玄學系統有完整的計算邏輯，不是簡單的「映射」或「包裝」**

3. **結果驗證與一致性檢查**（內部處理）：
   - 兩種計算結果必須一致
   - 科學計算結果作為驗證基準
   - 如果玄學計算結果與科學計算結果不一致，需要調整玄學計算邏輯或參數
   - **一致性優先**：如果出現不一致，優先以科學計算結果為準

4. **表層呈現**（使用者看到）：
   - 呈現給使用者的是：**玄學計算結果的模樣**
   - 但這個結果已經過驗證，與科學計算結果一致
   - 使用者只看到玄學系統，但結果是正確的（因為與科學計算一致）
   - 使用者**不知道**背後有科學計算和雙重驗證

#### 關鍵原則：

1. **玄學系統不是裝飾，而是真正的計算系統**
2. **雙重驗證機制**：科學計算和玄學計算必須同時進行
3. **一致性優先**：如果出現不一致，優先以科學計算結果為準

#### 禁止事項（嚴格禁止）：
- ❌ 不得讓玄學計算結果影響科學計算結果
- ❌ 不得為了「看起來像玄學」而犧牲結果的正確性
- ❌ 不得向使用者暴露科學計算過程
- ❌ 不得在科學計算階段使用玄學邏輯

---

## 三、系統架構（P0-5.5 決策）

### 3.1 系統 Canon：易經矩陣系統

**系統定義**：

> 一套以「八卦／六十四卦」作為狀態空間（Structure / State Space），  
> 以「五行生剋」作為動態解釋層（Dynamics / Interpretation），  
> 以「雙軌輸入（本命 × 流年）」驅動運算與敘事輸出（Dual-Track Engine）  
> 的動態神諭系統（Data-Driven Oracle）。

### 3.2 三層架構

#### 結構層（The Skeleton）：八卦 / 六十四卦
- **輸出**：`hexagram_id`（0-63 或 1-64，共 64 個卦象）
- **應用**：Stage 1（八卦分流）、Stage 4（卦象顯影）

#### 動態層（The Blood）：五行生剋
- **輸出**：`interaction_tags`（例如：generate / control / drain）
- **應用**：Stage 2（五行選擇）、結果解釋

#### 運算層（The Engine）：雙軌制（Root × Flow）
- **Track A**：先天本命（Root / Nature）- DOB → Root Element
- **Track B**：後天流年（Flow / Nurture）- Stage 1-3 → Hexagram
- **Collision**：`Result = f(Root, Flow)`

### 3.3 雙軌運算機制

#### Track A：先天本命（Root / Nature）
- **輸入**：DOB（出生年月日）- **選填**
- **計算**：DOB → Root Element（五行）
- **容錯**：若缺 DOB，使用 Stage 1-3 的行為資料推導「後天優勢屬性」
- **用途**：身份錨點、敘事個性化
- **決策權**：僅用於個性化，不得取代 Flow 的決策權

#### Track B：後天流年（Flow / Nurture）
- **輸入**：Stage 1-3 的互動選擇與問卷量表
- **計算**：Stage 1-3 → Hexagram + Changing Line
- **決策權**：最終建議、風險鏈、行動方案的決策權以 Flow 為準

#### Collision（碰撞運算）
- **核心形式**：`Result = f(Root, Flow)`
- **用途**：解釋「為何你是這樣的人（Root）」在「此刻遭遇這種局勢（Flow）」時會出現此壓力與風險走向

---

## 四、立即執行項目（P0-5.5 決策要求）

### 4.1 UMIP 演進至 v1.1（資料結構）

#### UserProfile 新增欄位
```typescript
interface UserProfile {
  dob: string | null;              // 出生年月日（ISO 8601 格式）
  root_element: RootElement | null; // 先天本命五行屬性
}

enum RootElement {
  METAL = "METAL",    // 金
  WOOD = "WOOD",      // 木
  WATER = "WATER",    // 水
  FIRE = "FIRE",      // 火
  EARTH = "EARTH"     // 土
}
```

#### ResultPayload 新增欄位
```typescript
interface ResultPayload {
  hexagram_id: number;                // 最終卦象 ID（0-63 或 1-64）
  changing_line_index: number | null; // 變爻索引（0-5 或 null）
  root_flow_collision_key: string;    // 碰撞運算結果鍵
}
```

### 4.2 核心演算法（最小可行）

1. **DOB → Root Element（干支/映射器）**
   - 功能：將出生年月日轉換為五行屬性
   - 使用傳統干支系統計算
   - 容錯：若 DOB 為 null，返回 null（由 Stage 1-3 推導器處理）

2. **Stage 1–3 → Hexagram + Changing Line（推導器）**
   - 功能：根據使用者的 Stage 1-3 互動選擇，推導出最終卦象和變爻
   - 需要建立「Stage 1-3 輸入 → 卦象」的映射邏輯
   - 需要考慮五行生剋關係
   - 需要確保結果與科學計算結果一致

3. **Root × Flow → Collision Narrative Key（模板索引）**
   - 功能：根據 Root 和 Flow 的組合，生成碰撞敘事鍵
   - 需要建立「Root × Hexagram → Collision Key」的映射表
   - 需要考慮五行生剋關係

### 4.3 Facet 內容錨定（從既有 facet 開始）

**目標**：建立 `income_expansion_pressure` Facet 與卦象路徑的對照表

**對照關係**：
- Facet 的科學計算結果（Score、Risk Level、Band）→ 對應的卦象（Hexagram ID）
- Facet 的特定問題回答組合 → 對應的變爻（Changing Line Index）

**注意事項**：
- 卦名（如「困」「渙」）可作為敘事素材，但**工程上必須以 `hexagram_id`/key 驅動**
- 避免語言造成耦合與翻譯漂移
- 需要建立可回溯的模板鍵（Traceable Template Keys）

---

## 五、交付物要求

### 5.1 必交付物

1. **UMIP v1.1 Schema 文件**
   - 文件位置：`schemas/umip_schema_v1.1.json`
   - 內容：包含 UserProfile 和 ResultPayload 的新欄位定義
   - 要求：向後兼容 UMIP v1.0

2. **核心演算法實作（代碼）**
   - DOB → Root Element 映射器（`engine/root_element_mapper.py` 或類似）
   - Stage 1-3 → Hexagram + Changing Line 推導器（`engine/hexagram_deriver.py` 或類似）
   - Root × Flow → Collision Narrative Key 計算器（`engine/collision_calculator.py` 或類似）

3. **Facet 內容錨定對照表**
   - 文件位置：`domain/facets/income_expansion_pressure.hexagram_mapping.v1.0.json`
   - 內容：Facet ↔ 卦象路徑對照

4. **測試用例與驗證機制**
   - 單元測試：每個演算法都需要測試用例
   - 整合測試：驗證雙重計算機制的一致性
   - Golden Tests：固定輸入輸出，確保行為穩定

5. **技術文檔**
   - 演算法說明文檔
   - API 使用說明（如適用）
   - 測試指南

### 5.2 預期時間

- **總預計時間**：2-3 週
- **分解**：
  - UMIP v1.1 Schema：1-2 天
  - 核心演算法實作：1-2 週
  - Facet 內容錨定：2-3 天
  - 測試與驗證：3-5 天

---

## 六、驗收標準

### 6.1 功能驗收

1. **UMIP v1.1 Schema 驗收**：
   - Schema 文件符合 JSON Schema 規範
   - 包含所有必需欄位（UserProfile、ResultPayload）
   - 向後兼容 UMIP v1.0

2. **核心演算法驗收**：
   - DOB → Root Element 映射器：正確處理有效/無效 DOB
   - Stage 1-3 → Hexagram + Changing Line 推導器：正確推導卦象和變爻
   - Root × Flow → Collision Narrative Key 計算器：正確生成碰撞鍵

3. **Facet 內容錨定驗收**：
   - 對照表結構正確
   - 映射關係與科學計算結果一致
   - 可回溯的模板鍵有效

4. **雙重計算機制驗收**：
   - 科學計算和玄學計算同時進行
   - 兩種計算結果一致（通過驗證測試）
   - 一致性檢查機制有效

### 6.2 品質驗收

1. **測試覆蓋率**：單元測試覆蓋率 ≥ 80%
2. **代碼品質**：代碼符合專案規範，可讀性良好
3. **文檔完整性**：技術文檔完整

---

## 七、相關文件索引

### 7.1 本任務包文件

- **任務包**：`P0-5.6_TASK_PACKET.md` - 完整的任務包（包含詳細說明）
- **工程師簡報**：`P0-5.6_ENGINEER_BRIEF.md` - 詳細的技術要求和背景資料
- **交付清單**：`P0-5.6_DELIVERY_CHECKLIST.md` - 交付文件確認清單
- **完整任務包**：`P0-5.6_COMPLETE_TASK_PACKAGE.md`（本文件）

### 7.2 核心決策文件

- **P0-5.5 決策文件**：`P0-5.5_ORIENTAL_ELEMENT_CONSULTATION/P0-5.5_ELEMENT_SELECTION_DECISION.md`
  - 系統架構定義、Stage 1-4 映射、雙軌運算機制、立即執行項目

- **P0-5.7 設計文檔**：`P0-5.7_WORLDVIEW_DESIGN/P0-5.7_DESIGN_DOC_FINAL.md`
  - 世界觀設計規格、Stage 1-4 互動方式定義、AI 敘事生成層規範

- **P0-5 UMIP 設計**：`P0-5/P0-5_UMIP_CLOSURE_REPORT.md`
  - UMIP 架構原則、視覺解耦機制、Stage 1-4 規格

### 7.3 背景資料文件

- **CHARTER**：`charter/CHARTER.md` - 專案終極目標、核心原則
- **進度分析報告**：`PROGRESS_ANALYSIS_2026-01-11.md` - 整體進度分析

### 7.4 技術文件

- **UMIP Schema v1.0**：`schemas/umip_schema_v1.json`
- **現有評分引擎**：`engine/score_facet.py`

---

## 八、下一步行動

### 8.1 開始實作前

1. 確認已閱讀並理解所有核心原則（特別是雙重計算原則）
2. 確認已理解系統架構（易經矩陣系統的三層架構）
3. 確認已理解立即執行項目（三個核心項目）
4. 如有疑問，請參考 `P0-5.6_ENGINEER_BRIEF.md` 獲取詳細技術要求

### 8.2 實作建議

1. **先實作 UMIP v1.1 Schema**：建立數據結構基礎
2. **再實作核心演算法**：從簡單到複雜，先實作 DOB → Root Element，再實作其他演算法
3. **最後實作 Facet 內容錨定**：建立對照表，驗證映射關係

### 8.3 驗收準備

1. 準備測試用例（單元測試、整合測試、Golden Tests）
2. 準備技術文檔（演算法說明、API 使用說明、測試指南）
3. 準備驗收演示（展示雙重計算機制的一致性）

---

## 九、聯繫與溝通

### 9.1 溝通原則

- **開放討論**：歡迎提出問題、質疑和建議
- **文檔記錄**：所有討論和決策都應記錄在案
- **迭代優化**：可以根據實際情況調整實作方向

### 9.2 時間安排

- **預計時間**：2-3 週
- **里程碑**：
  - 第 1 週：UMIP v1.1 Schema + 核心演算法（基礎實作）
  - 第 2 週：核心演算法（完整實作）+ Facet 內容錨定
  - 第 3 週：測試與驗證 + 技術文檔

---

**文件狀態**：READY FOR IMPLEMENTATION  
**下一步**：開始易經矩陣系統實作工作

---

**文件版本**：v1.0  
**最後更新**：2026-01-11

---

## 附錄：快速參考

### 關鍵概念速查

- **二元架構**：「後端科學極大化，前端玄學極致化」
- **雙重計算**：科學計算 + 玄學計算，結果必須一致
- **易經矩陣系統**：八卦/六十四卦（結構層）+ 五行生剋（動態層）+ 雙軌制（運算層）
- **雙軌制**：Track A（先天本命）+ Track B（後天流年）+ Collision（碰撞運算）

### 禁止事項速查

- ❌ 不得讓玄學計算結果影響科學計算結果
- ❌ 不得為了「看起來像玄學」而犧牲結果的正確性
- ❌ 不得向使用者暴露科學計算過程
- ❌ 不得在科學計算階段使用玄學邏輯

### 必交付物速查

1. UMIP v1.1 Schema 文件
2. 核心演算法實作（3 個演算法）
3. Facet 內容錨定對照表
4. 測試用例與驗證機制
5. 技術文檔
